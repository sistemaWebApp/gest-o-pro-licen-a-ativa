<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCboQje-660NNTe90tmS-HxF7_7hmTAhg4",
            authDomain: "gestorpro-fda39.firebaseapp.com",
            projectId: "gestorpro-fda39",
            storageBucket: "gestorpro-fda39.firebasestorage.app",
            messagingSenderId: "614355486570",
            appId: "1:614355486570:web:ec1b6f76020cde55b68713",
            measurementId: "G-2MYNYCG3DW"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        const DB_KEY = "GP_V69_CORRECTED";
        let myChart = null;
        let state = {
            license: "",
            storeDoc: "",
            startDate: null,
            inventory: {},
            dailyUsage: [],
            dailySales: 0,
            fixedCost: 0,
            currentFixedLeft: 0,
            historyLog: [],
            history: { labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'], values: [0, 0, 0, 0, 0, 0, 0] }
        };

        window.syncToCloud = async function() {
            if (!state.storeDoc || state.storeDoc === "") return;
            try {
                const dadosRef = doc(db, "dados_usuarios", state.storeDoc);
                await setDoc(dadosRef, state);
                console.log("Nuvem atualizada.");
            } catch (e) {
                console.error("Erro ao sincronizar:", e);
            }
        };

        window.addEventListener('load', () => {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                state = JSON.parse(saved);
                if (state.license) {
                    unlockApp();
                    initChart();
                    render();
                }
            }
        });

        window.handleLogin = async function() {
            const btn = document.getElementById('btn-login-fire');
            const keyDigitada = document.getElementById('license-key').value.trim().toUpperCase();
            const docInput = document.getElementById('auth-doc').value.trim().replace(/\D/g, '');

            if (docInput.length < 11 || keyDigitada.length < 3) {
                alert("Preencha CPF/CNPJ e Chave!");
                return;
            }

            btn.innerText = "VERIFICANDO...";
            btn.disabled = true;

            try {
                // CORREÃ‡ÃƒO: Agora buscando na coleÃ§Ã£o correta "licencas"
                const docRef = doc(db, "licencas", docInput);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().key === keyDigitada) {
                    const dadosRef = doc(db, "dados_usuarios", docInput);
                    const dadosSnap = await getDoc(dadosRef);

                    if (dadosSnap.exists()) {
                        // Restaura automaticamente os dados da nuvem para evitar erros
                        state = dadosSnap.data();
                    }
                    
                    state.license = keyDigitada;
                    state.storeDoc = docInput;
                    if (!state.startDate) state.startDate = new Date().getTime();

                    saveData(); 
                    unlockApp();
                    initChart();
                    render();
                    showToast("Acesso Autorizado!");
                } else {
                    alert("Dados de ativaÃ§Ã£o incorretos ou nÃ£o encontrados.");
                }
            } catch (e) {
                console.error("Erro no login:", e);
                alert("Erro de conexÃ£o. Verifique sua internet.");
            } finally {
                btn.innerText = "Ativar Sistema";
                btn.disabled = false;
            }
        };

        window.unlockApp = function() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-id-display').innerText = `ID: ${state.storeDoc.slice(-4)}`;
            checkExpiration();
        };

        window.checkExpiration = function() {
            const d = Math.floor((new Date().getTime() - state.startDate) / 86400000);
            const restantes = 365 - d;
            document.getElementById('days-left').innerText = `${restantes} DIAS RESTANTES`;
        };

        window.saveData = function() { localStorage.setItem(DB_KEY, JSON.stringify(state)); };

        window.saveInventory = function() {
            const name = document.getElementById('inv-name').value.trim().toUpperCase();
            const qty = parseFloat(document.getElementById('inv-qty').value);
            const unit = document.getElementById('inv-unit').value;
            const price = parseFloat(document.getElementById('inv-price').value);
            if (!name || isNaN(qty) || isNaN(price)) return;
            let baseQty = qty, baseUnit = unit, originalPricePerUnit = price / qty;
            if (unit === 'kg' || unit === 'L') { baseQty = qty * 1000; baseUnit = (unit === 'kg' ? 'g' : 'ml'); }
            if (!state.inventory[name]) state.inventory[name] = { stock: 0, pricePerBase: 0, unit: baseUnit, originalUnit: unit };
            const item = state.inventory[name];
            item.stock += baseQty;
            item.pricePerBase = price / baseQty;
            item.fullUnitPrice = originalPricePerUnit;
            saveData(); 
            render();
            syncToCloud(); 
            document.getElementById('inv-name').value = ""; document.getElementById('inv-qty').value = ""; document.getElementById('inv-price').value = "";
            showToast(`Cadastrado: ${formatBRL(originalPricePerUnit)} / ${unit}`);
        };

        window.removeInventoryItem = function(name) {
            if (confirm(`SÃ³cio, excluir "${name}"?`)) { 
                delete state.inventory[name]; 
                saveData(); 
                render(); 
                syncToCloud(); 
                showToast("Removido!"); 
            }
        };

        window.addUsage = function() {
            const name = document.getElementById('sel-insumo').value;
            const qty = parseFloat(document.getElementById('usage-qty').value);
            const unit = document.getElementById('usage-unit').value;
            if (!name || isNaN(qty)) return;
            let baseQty = (unit === 'kg' || unit === 'L') ? qty * 1000 : qty;
            const item = state.inventory[name];
            if (baseQty > item.stock) return alert("Estoque insuficiente!");
            item.stock -= baseQty;
            state.dailyUsage.push({ id: Date.now(), name, qty, unit, cost: baseQty * item.pricePerBase, baseQty });
            saveData(); 
            render(); 
            showToast("Uso registrado!");
        };

        window.addSale = function() {
            const v = parseFloat(document.getElementById('sale-val').value);
            if (isNaN(v)) return;
            state.dailySales += v; saveData(); render();
            document.getElementById('sale-val').value = "";
        };

        window.saveConfig = function() {
            state.fixedCost = parseFloat(document.getElementById('cfg-fixed').value) || 0;
            state.currentFixedLeft = state.fixedCost; 
            saveData(); 
            render(); 
            syncToCloud(); 
            showToast("Meta Definida!");
        };

        window.closeDay = function() {
            const tCosts = state.dailyUsage.reduce((a, b) => a + b.cost, 0);
            const tProfit = state.dailySales - tCosts;
            state.currentFixedLeft = Math.max(0, state.currentFixedLeft - tProfit);
            state.historyLog.unshift({ date: new Date().toLocaleDateString('pt-BR'), sales: state.dailySales, costs: tCosts, profit: tProfit });
            if (state.historyLog.length > 30) state.historyLog.pop();
            state.dailySales = 0; state.dailyUsage = [];
            saveData(); 
            render(); 
            syncToCloud();
            showToast("Dia Encerrado e Salvo na Nuvem!");
        };

        window.clearHistory = function() {
            if (confirm("Limpar histÃ³rico?")) { 
                state.historyLog = []; 
                saveData(); 
                render(); 
                syncToCloud(); 
            }
        };

        window.sendWhatsAppReport = function() {
            const tCosts = state.dailyUsage.reduce((a, b) => a + b.cost, 0);
            const tProfit = state.dailySales - tCosts;
            const msg = `*RESUMO DO DIA*%0AðŸ’° Vendas: ${formatBRL(state.dailySales)}%0AðŸ“‰ Custos: ${formatBRL(tCosts)}%0Aâœ… Lucro: ${formatBRL(tProfit)}`;
            window.open(`https://wa.me/?text=${msg}`);
        };

        window.render = function() {
            const tCosts = state.dailyUsage.reduce((a, b) => a + b.cost, 0);
            const tProfit = state.dailySales - tCosts;
            document.getElementById('m-sales').innerText = formatBRL(state.dailySales);
            document.getElementById('m-costs').innerText = formatBRL(tCosts);
            document.getElementById('m-profit').innerText = formatBRL(tProfit);
            document.getElementById('m-be').innerText = formatBRL(state.currentFixedLeft);
            const percFaltante = state.fixedCost > 0 ? (state.currentFixedLeft / state.fixedCost) * 100 : 0;
            document.getElementById('m-be-percent').innerText = `Faltam ${percFaltante.toFixed(1)}% para a meta`;
            const prog = state.fixedCost > 0 ? ((state.fixedCost - state.currentFixedLeft) / state.fixedCost) * 100 : 0;
            document.getElementById('be-progress').style.width = `${Math.min(prog, 100)}%`;
            const sel = document.getElementById('sel-insumo');
            sel.innerHTML = '<option value="">Selecionar...</option>';
            Object.keys(state.inventory).sort().forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
            document.getElementById('usage-list').innerHTML = state.dailyUsage.map(u => `<tr><td class="px-8 py-4 font-bold text-xs">${u.name}</td><td class="px-8 py-4 text-xs">${u.qty}${u.unit}</td><td class="px-8 py-4 text-right text-red-500 font-black">${formatBRL(u.cost)}</td><td class="px-8 py-4 text-center"><button onclick="deleteUsage(${u.id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            document.getElementById('inventory-grid').innerHTML = Object.entries(state.inventory).map(([n, d]) => `<div class="glass-card p-6 ${d.stock < 500 ? 'critical-stock' : 'border-t-4 border-blue-500'}"><button onclick="removeInventoryItem('${n}')" class="delete-btn"><i class="fas fa-trash-alt"></i></button><div class="space-y-3"><h4 class="font-black text-[10px] uppercase text-slate-400">${n}</h4><p class="text-2xl font-black">${Math.round(d.stock)}<small class="text-xs ml-1 opacity-50">${d.unit}</small></p><div class="space-y-1"><p class="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-1 rounded inline-block">Valor p/ ${d.originalUnit || 'un'}: ${formatBRL(d.fullUnitPrice || 0)}</p></div></div></div>`).join('');
            document.getElementById('history-list').innerHTML = state.historyLog.map(h => `<tr><td class="py-4 text-slate-500">${h.date}</td><td class="py-4 text-right">${formatBRL(h.sales)}</td><td class="py-4 text-right text-red-400">${formatBRL(h.costs)}</td><td class="py-4 text-right text-green-600">${formatBRL(h.profit)}</td></tr>`).join('');
            updateChart();
        };

        window.deleteUsage = function(id) {
            const idx = state.dailyUsage.findIndex(x => x.id === id);
            if (idx > -1) { const u = state.dailyUsage[idx]; if (state.inventory[u.name]) state.inventory[u.name].stock += u.baseQty; state.dailyUsage.splice(idx, 1); saveData(); render(); }
        };

        window.formatBRL = function(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); };
        window.showToast = function(m) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; t.classList.remove('opacity-0'); setTimeout(() => t.classList.add('opacity-0'), 2000); };
        window.switchTab = function(t) { 
            document.getElementById('section-dash').classList.toggle('hidden', t !== 'dash'); 
            document.getElementById('section-inventory').classList.toggle('hidden', t !== 'inventory'); 
            document.getElementById('tab-dash').classList.toggle('tab-active', t === 'dash'); 
            document.getElementById('tab-inventory').classList.toggle('tab-active', t === 'inventory'); 
        };
        window.handleLogout = function() { localStorage.removeItem(DB_KEY); location.reload(); };

        window.initChart = function() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Lucro (R$)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            updateChart();
        };

        window.updateChart = function() {
            if (!myChart) return;
            const lastData = [...state.historyLog].slice(0, 7).reverse();
            if (lastData.length > 0) {
                myChart.data.labels = lastData.map(d => d.date.split('/')[0] + '/' + d.date.split('/')[1]);
                myChart.data.datasets[0].data = lastData.map(d => d.profit);
            }
            myChart.update();
        };
    </script>
