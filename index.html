<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Pro Enterprise AI - v8.1 Backup Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        navy: { 950: '#0f172a', 900: '#1e293b', 800: '#334155' },
                        electric: { 500: '#3b82f6', 600: '#2563eb' },
                        ai: { 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed' },
                        backup: { 500: '#10b981', 600: '#059669' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'spin-slow': 'spin 3s linear infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-subtle: #e2e8f0;
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-subtle: #334155;
        }

        body { background-color: var(--bg-secondary); color: var(--text-primary); }
        
        .glass-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
        }

        .glass-panel:hover { transform: translateY(-2px); }
        
        .tab-active { 
            color: #3b82f6 !important; 
            position: relative;
        }
        
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3b82f6;
            border-radius: 3px 3px 0 0;
        }

        .critical-stock { 
            border-left: 4px solid #ef4444; 
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
        }

        .ai-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .ai-glow {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .backup-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .backup-glow {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .tabular-nums { font-variant-numeric: tabular-nums; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
        }
        .print-only { display: none; }

        .days-badge { transition: all 0.3s ease; }
        .days-badge.warning { background: #fef3c7; color: #d97706; }
        .days-badge.danger { background: #fee2e2; color: #dc2626; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .ai-badge {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            font-size: 8px;
            padding: 3px 8px;
            border-radius: 9999px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            height: 18px;
        }

        .backup-badge {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            font-size: 9px;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .insight-card {
            border-left: 3px solid #8b5cf6;
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
        }

        .backup-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
        }

        .sync-indicator {
            animation: spin 1s linear infinite;
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            display: inline-block;
        }

        /* Estilo para código de backup */
        .backup-code {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.1em;
            word-break: break-all;
        }
    </style>
<base target="_blank">
</head>
<body class="antialiased">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[9999] bg-navy-950 flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 animate-slide-up">
            <div class="w-20 h-20 bg-gradient-to-br from-electric-500 to-electric-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-8">
                <i class="fas fa-rocket text-white text-3xl"></i>
            </div>
            <h2 class="text-3xl font-black text-center mb-2">Ativação Enterprise</h2>
            <p class="text-sm text-center text-[var(--text-secondary)] mb-8">Licença de 365 dias a partir do primeiro acesso</p>
            
            <div class="space-y-4">
                <input type="text" id="auth-doc" maxlength="18" 
                    class="w-full p-5 bg-[var(--bg-tertiary)] rounded-2xl text-center text-lg font-bold uppercase tracking-wider border-2 border-transparent focus:border-electric-500 outline-none transition-all"
                    placeholder="CPF ou CNPJ">
                <input type="password" id="license-key" 
                    class="w-full p-5 bg-[var(--bg-tertiary)] rounded-2xl text-center text-xl font-bold uppercase tracking-[0.2em] border-2 border-transparent focus:border-electric-500 outline-none transition-all"
                    placeholder="CHAVE DE ACESSO">
            </div>

            <button onclick="Auth.login()" id="btn-login" 
                class="w-full mt-8 bg-electric-600 hover:bg-electric-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase text-xs tracking-[0.2em]">
                <span id="login-text">Ativar Sistema</span>
                <i id="login-spinner" class="fas fa-circle-notch fa-spin hidden ml-2"></i>
            </button>

            <button onclick="UI.showModal('register-modal')" 
                class="w-full mt-4 text-electric-600 font-bold text-[11px] uppercase tracking-widest">
                Primeiro Acesso? Criar Senha
            </button>

            <!-- Botão de Recuperação de Backup -->
            <button onclick="Backup.showRestoreModal()" 
                class="w-full mt-4 text-backup-600 font-bold text-[11px] uppercase tracking-widest flex items-center justify-center gap-2">
                <i class="fas fa-cloud-download-alt"></i> Restaurar Backup Existente
            </button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="fixed inset-0 z-[10000] bg-navy-950/90 hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 animate-slide-up">
            <h3 class="text-2xl font-black mb-6 text-center">Criar Meu Acesso</h3>
            <div class="space-y-4">
                <input type="text" id="reg-doc" class="w-full p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="CPF/CNPJ">
                <input type="password" id="reg-key" class="w-full p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="Crie sua Senha">
                <button onclick="Auth.register()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-xl uppercase text-xs">Cadastrar</button>
                <button onclick="UI.hideModal('register-modal')" class="w-full text-[var(--text-secondary)] font-bold text-[11px] uppercase mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div id="edit-inventory-modal" class="fixed inset-0 z-[10000] bg-navy-950/90 hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg p-8 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Renovar Estoque</h3>
                <button onclick="UI.hideModal('edit-inventory-modal')" class="text-[var(--text-secondary)] hover:text-red-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    Editando: <strong id="edit-item-name" class="uppercase"></strong>
                </p>
                <p class="text-xs text-blue-600 mt-1">Estoque atual: <span id="edit-current-stock" class="font-bold"></span></p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2 block">Quantidade a Adicionar</label>
                    <div class="flex gap-2">
                        <input type="number" id="edit-add-qty" class="flex-1 p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="Ex: 10">
                        <select id="edit-unit" class="p-4 bg-[var(--bg-tertiary)] rounded-xl text-sm font-black uppercase min-w-[100px] border-2 border-transparent focus:border-electric-500 outline-none">
                            <option value="kg">KG</option>
                            <option value="L">L</option>
                            <option value="un">UN</option>
                            <option value="g">g</option>
                            <option value="ml">ml</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2 block">Preço Total Pago (novo lote)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-sm font-bold text-[var(--text-secondary)]">R$</span>
                        <input type="number" id="edit-add-price" class="w-full p-4 pl-10 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="Valor pago no novo lote">
                    </div>
                    <p class="text-[10px] text-[var(--text-secondary)] mt-1">*O sistema calculará o preço médio ponderado automaticamente</p>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="Inventory.saveEdit()" class="flex-1 bg-electric-600 hover:bg-electric-500 text-white font-black py-4 rounded-xl uppercase text-xs tracking-widest transition-all">
                        <i class="fas fa-save mr-2"></i>Salvar Renovação
                    </button>
                    <button onclick="UI.hideModal('edit-inventory-modal')" class="px-6 bg-[var(--bg-tertiary)] text-[var(--text-secondary)] font-black py-4 rounded-xl uppercase text-xs hover:bg-gray-200 transition-all">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Modal -->
    <div id="ai-insights-modal" class="fixed inset-0 z-[10000] bg-navy-950/95 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="glass-panel w-full max-w-4xl p-8 animate-slide-up my-8">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-ai-500 to-ai-600 rounded-xl flex items-center justify-center ai-glow">
                        <i class="fas fa-brain text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black">Análise Inteligente</h3>
                        <p class="text-xs text-[var(--text-secondary)] font-bold uppercase tracking-wider">Powered by IA Analytics</p>
                    </div>
                </div>
                <button onclick="UI.hideModal('ai-insights-modal')" class="text-[var(--text-secondary)] hover:text-red-500 p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div id="ai-content" class="space-y-6">
                <!-- Content populated by AI module -->
            </div>
        </div>
    </div>

    <!-- BACKUP & SYNC MODAL -->
    <div id="backup-modal" class="fixed inset-0 z-[10000] bg-navy-950/95 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="glass-panel w-full max-w-4xl p-8 animate-slide-up my-8">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-backup-500 to-backup-600 rounded-xl flex items-center justify-center backup-glow">
                        <i class="fas fa-shield-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black">Backup & Sincronização</h3>
                        <p class="text-xs text-[var(--text-secondary)] font-bold uppercase tracking-wider">Proteção Total dos Dados</p>
                    </div>
                </div>
                <button onclick="UI.hideModal('backup-modal')" class="text-[var(--text-secondary)] hover:text-red-500 p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Status do Backup -->
                <div class="backup-card p-6 rounded-2xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-backup-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-database text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-black text-sm">Status do Sistema</h4>
                            <p class="text-[10px] text-[var(--text-secondary)]">Última atualização: <span id="backup-last-time">--</span></p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-[var(--border-subtle)]">
                            <span class="text-xs text-[var(--text-secondary)]">Tamanho dos Dados</span>
                            <span id="backup-size" class="text-xs font-black">0 KB</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-[var(--border-subtle)]">
                            <span class="text-xs text-[var(--text-secondary)]">Registros</span>
                            <span id="backup-records" class="text-xs font-black">0 itens</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-xs text-[var(--text-secondary)]">Integridade</span>
                            <span class="text-xs font-black text-emerald-600 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> 100%
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Ações Rápidas -->
                <div class="space-y-3">
                    <button onclick="Backup.exportToFile()" class="w-full p-4 bg-backup-600 hover:bg-backup-500 text-white rounded-xl font-black text-xs uppercase tracking-wider transition-all flex items-center justify-center gap-3">
                        <i class="fas fa-download text-lg"></i>
                        <div class="text-left">
                            <div>Exportar Arquivo</div>
                            <div class="text-[9px] opacity-80 font-normal">Salvar .JSON no dispositivo</div>
                        </div>
                    </button>
                    
                    <button onclick="Backup.generateShareCode()" class="w-full p-4 bg-electric-600 hover:bg-electric-500 text-white rounded-xl font-black text-xs uppercase tracking-wider transition-all flex items-center justify-center gap-3">
                        <i class="fas fa-share-alt text-lg"></i>
                        <div class="text-left">
                            <div>Código de Transferência</div>
                            <div class="text-[9px] opacity-80 font-normal">Copiar código para outro aparelho</div>
                        </div>
                    </button>
                    
                    <button onclick="Backup.exportToWhatsApp()" class="w-full p-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-black text-xs uppercase tracking-wider transition-all flex items-center justify-center gap-3">
                        <i class="fab fa-whatsapp text-lg"></i>
                        <div class="text-left">
                            <div>Enviar por WhatsApp</div>
                            <div class="text-[9px] opacity-80 font-normal">Backup criptografado</div>
                        </div>
                    </button>

                    <label class="w-full p-4 bg-[var(--bg-tertiary)] hover:bg-[var(--bg-secondary)] border-2 border-dashed border-[var(--border-subtle)] rounded-xl font-black text-xs uppercase tracking-wider transition-all flex items-center justify-center gap-3 cursor-pointer">
                        <i class="fas fa-upload text-lg text-[var(--text-secondary)]"></i>
                        <div class="text-left">
                            <div class="text-[var(--text-primary)]">Importar Arquivo</div>
                            <div class="text-[9px] text-[var(--text-secondary)] font-normal">Selecionar arquivo .JSON</div>
                        </div>
                        <input type="file" id="backup-file-input" accept=".json" class="hidden" onchange="Backup.importFromFile(this)">
                    </label>
                </div>
            </div>

            <!-- Código de Transferência -->
            <div id="transfer-code-section" class="hidden mb-8">
                <div class="glass-panel p-6 bg-gradient-to-r from-electric-50 to-ai-50 border-2 border-electric-200">
                    <h4 class="font-black text-xs uppercase mb-4 text-electric-600 flex items-center gap-2">
                        <i class="fas fa-key"></i> Código de Transferência (válido por 24h)
                    </h4>
                    <div class="bg-white p-4 rounded-xl border-2 border-dashed border-electric-300 mb-4">
                        <code id="transfer-code-display" class="backup-code text-sm text-[var(--text-primary)] block text-center select-all"></code>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="Backup.copyTransferCode()" class="flex-1 bg-electric-600 text-white py-3 rounded-xl font-black text-xs uppercase hover:bg-electric-500 transition-all">
                            <i class="fas fa-copy mr-2"></i>Copiar Código
                        </button>
                        <button onclick="Backup.hideTransferCode()" class="px-6 bg-[var(--bg-tertiary)] text-[var(--text-secondary)] py-3 rounded-xl font-black text-xs uppercase hover:bg-gray-200 transition-all">
                            Ocultar
                        </button>
                    </div>
                    <p class="text-[10px] text-[var(--text-secondary)] mt-3 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        Cole este código no outro dispositivo em "Restaurar Backup"
                    </p>
                </div>
            </div>

            <!-- Importar por Código -->
            <div class="glass-panel p-6 mb-8">
                <h4 class="font-black text-xs uppercase mb-4 text-[var(--text-secondary)] flex items-center gap-2">
                    <i class="fas fa-file-import"></i> Importar por Código
                </h4>
                <div class="flex gap-3">
                    <textarea id="import-code-input" rows="3" class="flex-1 p-4 bg-[var(--bg-tertiary)] rounded-xl text-xs font-mono border-2 border-[var(--border-subtle)] focus:border-electric-500 outline-none resize-none" placeholder="Cole aqui o código de transferência..."></textarea>
                    <button onclick="Backup.importFromCode()" class="px-6 bg-electric-600 text-white rounded-xl font-black text-xs uppercase hover:bg-electric-500 transition-all flex items-center gap-2">
                        <i class="fas fa-play"></i>
                        <span>Importar</span>
                    </button>
                </div>
            </div>

            <!-- Histórico de Backups -->
            <div class="glass-panel p-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-black text-xs uppercase text-[var(--text-secondary)] flex items-center gap-2">
                        <i class="fas fa-history"></i> Histórico de Backups
                    </h4>
                    <button onclick="Backup.clearHistory()" class="text-[10px] text-red-500 hover:text-red-700 font-bold uppercase">
                        <i class="fas fa-trash mr-1"></i>Limpar
                    </button>
                </div>
                <div id="backup-history-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <p class="text-sm text-[var(--text-secondary)] text-center py-4">Nenhum backup registrado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- RESTORE MODAL (para tela de login) -->
    <div id="restore-modal" class="fixed inset-0 z-[10001] bg-navy-950/95 hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg p-8 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black flex items-center gap-2">
                    <i class="fas fa-cloud-download-alt text-backup-500"></i> Restaurar Dados
                </h3>
                <button onclick="UI.hideModal('restore-modal')" class="text-[var(--text-secondary)] hover:text-red-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-backup-50 border border-backup-200 rounded-xl">
                    <p class="text-sm text-backup-800 mb-2">Tem um código de transferência?</p>
                    <textarea id="restore-code-input" rows="4" class="w-full p-3 bg-white rounded-lg text-xs font-mono border border-backup-300 focus:border-backup-500 outline-none resize-none" placeholder="Cole o código aqui..."></textarea>
                    <button onclick="Backup.restoreFromCode()" class="w-full mt-3 bg-backup-600 text-white py-3 rounded-lg font-black text-xs uppercase hover:bg-backup-500 transition-all">
                        <i class="fas fa-magic mr-2"></i>Restaurar Dados
                    </button>
                </div>

                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-[var(--border-subtle)]"></div>
                    </div>
                    <div class="relative flex justify-center text-xs uppercase">
                        <span class="px-2 bg-[var(--bg-primary)] text-[var(--text-secondary)]">ou</span>
                    </div>
                </div>

                <label class="block p-4 bg-[var(--bg-tertiary)] hover:bg-[var(--bg-secondary)] border-2 border-dashed border-[var(--border-subtle)] rounded-xl cursor-pointer text-center transition-all">
                    <i class="fas fa-file-upload text-2xl text-[var(--text-secondary)] mb-2"></i>
                    <p class="text-xs font-bold text-[var(--text-primary)]">Selecionar arquivo JSON</p>
                    <p class="text-[10px] text-[var(--text-secondary)] mt-1">Backup exportado anteriormente</p>
                    <input type="file" accept=".json" class="hidden" onchange="Backup.restoreFromFile(this)">
                </label>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-content" class="hidden">
        <!-- Navigation -->
        <nav class="glass-panel sticky top-0 z-40 rounded-none border-x-0 border-t-0 no-print backdrop-blur-md">
            <div class="max-w-7xl mx-auto px-4 lg:px-6 flex justify-between items-center h-16 gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-electric-500 to-electric-600 rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-rocket text-white text-lg"></i>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="font-black text-xl italic tracking-tight">GESTÃO<span class="text-electric-500">PRO</span></span>
                            <span class="ai-badge">AI</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="user-id" class="text-[10px] font-bold text-[var(--text-secondary)]">ID: ----</span>
                            <span class="text-[var(--border-subtle)]">|</span>
                            <span id="days-left" class="days-badge bg-emerald-100 text-emerald-700 text-[9px] px-2 py-0.5 rounded-full font-black">365 DIAS</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <div class="flex gap-1 mr-4 border-b border-[var(--border-subtle)]">
                        <button onclick="App.switchTab('dash')" id="tab-dash" class="tab-btn px-4 py-5 text-[11px] font-black uppercase transition-colors tab-active">Dashboard</button>
                        <button onclick="App.switchTab('inventory')" id="tab-inventory" class="tab-btn px-4 py-5 text-[11px] font-black uppercase text-[var(--text-secondary)] transition-colors">Estoque</button>
                        <button onclick="App.switchTab('recipes')" id="tab-recipes" class="tab-btn px-4 py-5 text-[11px] font-black uppercase text-[var(--text-secondary)] transition-colors">Ficha Técnica</button>
                        <button onclick="App.switchTab('analytics')" id="tab-analytics" class="tab-btn px-4 py-5 text-[11px] font-black uppercase text-[var(--text-secondary)] transition-colors flex items-center gap-2">
                            <i class="fas fa-chart-line text-ai-500"></i> Analytics
                        </button>
                    </div>

                    <button onclick="AI.showInsights()" class="flex items-center gap-2 bg-gradient-to-r from-ai-500 to-ai-600 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:shadow-ai-500/50 transition-all no-print animate-pulse-slow">
                        <i class="fas fa-robot"></i>IA Insights
                    </button>
                    
                    <!-- Botão de Backup -->
                    <button onclick="Backup.openModal()" class="flex items-center gap-2 bg-gradient-to-r from-backup-500 to-backup-600 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:shadow-backup-500/50 transition-all no-print">
                        <i class="fas fa-shield-alt"></i>Backup
                    </button>
                    
                    <button onclick="Reports.generatePDF()" class="flex items-center gap-2 bg-navy-900 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase no-print">
                        <i class="fas fa-file-pdf"></i>PDF
                    </button>
                    <button onclick="Reports.sendWhatsApp()" class="flex items-center gap-2 bg-emerald-100 text-emerald-700 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase border border-emerald-200 no-print">
                        <i class="fab fa-whatsapp"></i>WhatsApp
                    </button>
                    <button onclick="App.closeDay()" class="bg-red-600 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase no-print">Fechar Dia</button>
                    <button onclick="Auth.logout()" class="text-[var(--text-secondary)] hover:text-red-500 no-print"><i class="fas fa-power-off text-lg"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6 space-y-8 pb-32">
            
            <!-- PDF Header -->
            <div id="pdf-header" class="print-only text-center border-b-4 border-electric-500 pb-6 mb-8">
                <h1 class="text-3xl font-black italic">GESTÃO PRO <span class="text-electric-500">ENTERPRISE</span> <span class="text-ai-500">AI</span></h1>
                <p class="text-xs font-bold text-[var(--text-secondary)] uppercase mt-2">Relatório Executivo Inteligente</p>
                <p id="pdf-date" class="text-sm font-black mt-4"></p>
            </div>

            <!-- DASHBOARD SECTION -->
            <div id="section-dash" class="space-y-8 animate-fade-in">
                
                <!-- AI Status Bar -->
                <div class="glass-panel p-4 bg-gradient-to-r from-ai-500/10 to-electric-500/10 border border-ai-500/20 no-print">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-robot text-ai-500 text-xl animate-float"></i>
                            <div>
                                <p class="text-xs font-black uppercase text-ai-600">Assistente IA Ativo</p>
                                <p id="ai-status-text" class="text-[10px] text-[var(--text-secondary)]">Analisando padrões de vendas...</p>
                            </div>
                        </div>
                        <div class="flex gap-4 text-[10px] font-bold">
                            <span class="flex items-center gap-1"><i class="fas fa-check-circle text-emerald-500"></i> Estoque OK</span>
                            <span class="flex items-center gap-1"><i class="fas fa-chart-line text-electric-500"></i> Tendência: <span id="trend-indicator">Estável</span></span>
                        </div>
                    </div>
                </div>

                <!-- Backup Status Widget -->
                <div id="backup-status-widget" class="glass-panel p-4 bg-gradient-to-r from-backup-500/10 to-emerald-500/10 border border-backup-500/20 no-print cursor-pointer hover:shadow-lg transition-all" onclick="Backup.openModal()">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-backup-500 to-backup-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-shield-check text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs font-black uppercase text-backup-600">Backup Automático</p>
                                <p id="backup-widget-text" class="text-[10px] text-[var(--text-secondary)]">Último: há 2 horas • Clique para gerenciar</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="backup-sync-status" class="text-[10px] font-bold text-emerald-600 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> Protegido
                            </span>
                            <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                        </div>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="metrics-container">
                    <div class="glass-panel p-6 border-b-4 border-electric-500 metric-card">
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Vendas Hoje</p>
                        <h3 id="metric-sales" class="text-3xl font-black tabular-nums text-[var(--text-primary)]">R$ 0,00</h3>
                        <p id="sales-trend" class="text-[10px] mt-2 font-bold text-emerald-600 flex items-center gap-1">
                            <i class="fas fa-arrow-up"></i> <span>+0%</span> vs ontem
                        </p>
                    </div>
                    
                    <div class="glass-panel p-6 border-b-4 border-red-500 metric-card">
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Custo Materiais</p>
                        <h3 id="metric-costs" class="text-3xl font-black tabular-nums text-red-500">R$ 0,00</h3>
                        <p id="cost-margin" class="text-[10px] mt-2 font-bold text-[var(--text-secondary)]">Margem: --%</p>
                    </div>
                    
                    <div class="glass-panel p-6 border-b-4 border-emerald-500 metric-card">
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Lucro Bruto Hoje</p>
                        <h3 id="metric-profit" class="text-3xl font-black tabular-nums text-emerald-600">R$ 0,00</h3>
                        <p id="profit-per-hour" class="text-[10px] mt-2 font-bold text-[var(--text-secondary)]">R$ --/hora</p>
                    </div>
                    
                    <div id="card-be" class="glass-panel p-6 border-b-4 border-amber-500 metric-card">
                        <p id="label-be" class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Pendente Break-Even</p>
                        <h3 id="metric-be" class="text-2xl font-black tabular-nums">R$ 0,00</h3>
                        <span id="badge-be" class="inline-block mt-2 text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded-full">Faltam 100%</span>
                        <div class="w-full bg-[var(--bg-tertiary)] h-2 mt-3 rounded-full overflow-hidden no-print">
                            <div id="progress-be" class="bg-amber-500 h-full w-0 transition-all duration-500"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Predictions Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 no-print">
                    <div class="glass-panel p-6 ai-card">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-brain text-ai-500"></i>
                            <span class="text-[10px] font-black uppercase text-ai-600">Previsão IA - Amanhã</span>
                        </div>
                        <h4 id="ai-prediction-sales" class="text-2xl font-black tabular-nums">R$ 0,00</h4>
                        <p class="text-[10px] text-[var(--text-secondary)] mt-1">Baseado nos últimos 7 dias</p>
                    </div>
                    
                    <div class="glass-panel p-6 ai-card">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-boxes text-ai-500"></i>
                            <span class="text-[10px] font-black uppercase text-ai-600">Alerta de Estoque</span>
                        </div>
                        <h4 id="ai-stock-alert" class="text-2xl font-black">0 itens</h4>
                        <p class="text-[10px] text-[var(--text-secondary)] mt-1">Necessitam reposição em 3 dias</p>
                    </div>
                    
                    <div class="glass-panel p-6 ai-card">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-trophy text-ai-500"></i>
                            <span class="text-[10px] font-black uppercase text-ai-600">Produto Estrela</span>
                        </div>
                        <h4 id="ai-top-product" class="text-lg font-black truncate">--</h4>
                        <p id="ai-top-product-margin" class="text-[10px] text-emerald-600 font-bold mt-1">Margem: --%</p>
                    </div>
                </div>

                <!-- PDF Monthly Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 hidden print:grid" id="pdf-summary">
                    <div class="glass-panel p-6 bg-[var(--bg-tertiary)]">
                        <p class="text-[9px] font-black uppercase text-[var(--text-secondary)]">Vendas (30d)</p>
                        <h4 id="pdf-sales" class="text-xl font-black tabular-nums mt-2">R$ 0,00</h4>
                    </div>
                    <div class="glass-panel p-6 bg-[var(--bg-tertiary)]">
                        <p class="text-[9px] font-black uppercase text-[var(--text-secondary)]">Custos (30d)</p>
                        <h4 id="pdf-costs" class="text-xl font-black tabular-nums mt-2">R$ 0,00</h4>
                    </div>
                    <div class="glass-panel p-6 bg-[var(--bg-tertiary)]">
                        <p class="text-[9px] font-black uppercase text-[var(--text-secondary)]">Lucro (30d)</p>
                        <h4 id="pdf-profit" class="text-xl font-black tabular-nums mt-2">R$ 0,00</h4>
                    </div>
                </div>

                <!-- Quick Sale -->
                <div class="glass-panel p-8 bg-gradient-to-br from-navy-900 to-navy-800 text-white no-print">
                    <h4 class="font-black text-xs uppercase mb-6 text-electric-400 tracking-widest flex items-center gap-2">
                        <i class="fas fa-bolt"></i> Venda Automática (Ficha Técnica)
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="relative">
                            <label class="text-[10px] text-navy-400 uppercase font-bold mb-1 block">Produto</label>
                            <select id="select-product" class="w-full bg-navy-800 border border-navy-700 p-4 rounded-xl text-sm font-bold text-white outline-none focus:border-electric-500 transition-colors">
                                <option value="">Selecionar Produto...</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label class="text-[10px] text-navy-400 uppercase font-bold mb-1 block">Quantidade</label>
                            <input type="number" id="sale-qty" min="1" step="1" class="w-full bg-navy-800 border border-navy-700 p-4 rounded-xl text-sm font-bold text-white outline-none focus:border-electric-500 transition-colors placeholder-navy-500" placeholder="Ex: 5">
                        </div>
                        <div class="flex items-end">
                            <button onclick="Sales.sellProduct()" id="btn-sell-product" class="w-full bg-electric-600 hover:bg-electric-500 disabled:opacity-50 disabled:cursor-not-allowed py-4 rounded-xl font-black uppercase text-xs tracking-widest transition-all shadow-lg flex items-center justify-center gap-2">
                                <span>Confirmar e Baixar</span>
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <div id="sale-status" class="mt-4 text-xs font-bold text-center hidden"></div>
                </div>

                <!-- Usage Table -->
                <div class="glass-panel overflow-hidden">
                    <div class="p-6 border-b border-[var(--border-subtle)] flex flex-wrap gap-4 justify-between items-center bg-[var(--bg-primary)]">
                        <h4 class="font-black text-xs uppercase tracking-widest text-electric-500">
                            <i class="fas fa-list-ul mr-2"></i>Detalhamento de Insumos (Saídas)
                        </h4>
                        <div class="flex gap-3 items-center no-print">
                            <select id="select-insumo" class="bg-[var(--bg-tertiary)] p-3.5 rounded-xl text-xs font-bold min-w-[180px] border border-[var(--border-subtle)] outline-none focus:border-electric-500">
                                <option value="">Selecionar Insumo...</option>
                            </select>
                            <input type="number" id="usage-qty-input" class="bg-[var(--bg-tertiary)] p-3.5 w-24 rounded-xl text-xs font-bold border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Qtd.">
                            <select id="usage-unit-input" class="bg-[var(--bg-tertiary)] p-3.5 rounded-xl text-[10px] font-black uppercase border border-[var(--border-subtle)] outline-none">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="ml">ml</option>
                                <option value="L">L</option>
                                <option value="un">un</option>
                            </select>
                            <button onclick="Sales.addManualUsage()" class="bg-electric-600 text-white w-12 h-12 rounded-xl shadow-lg flex items-center justify-center hover:bg-electric-500 transition-all">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-[var(--bg-tertiary)] text-[var(--text-secondary)] font-black text-[10px] uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-left">Insumo</th>
                                    <th class="px-6 py-4 text-left">Quantidade</th>
                                    <th class="px-6 py-4 text-right">Custo</th>
                                    <th class="px-6 py-4 text-center no-print">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="table-usage" class="divide-y divide-[var(--border-subtle)]">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts & History -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-panel p-6">
                                <h4 class="font-black text-xs uppercase mb-4 text-[var(--text-secondary)]">Evolução do Lucro</h4>
                                <div class="h-64"><canvas id="chart-main"></canvas></div>
                            </div>
                            <div class="glass-panel p-6">
                                <h4 class="font-black text-xs uppercase mb-4 text-[var(--text-secondary)]">Proporção (30 dias)</h4>
                                <div class="h-64"><canvas id="chart-pizza"></canvas></div>
                            </div>
                        </div>

                        <!-- AI Recommendations -->
                        <div class="glass-panel p-6 no-print ai-card">
                            <div class="flex items-center gap-2 mb-4">
                                <i class="fas fa-lightbulb text-ai-500 text-xl"></i>
                                <h4 class="font-black text-xs uppercase text-ai-600">Recomendações da IA</h4>
                            </div>
                            <div id="ai-recommendations" class="space-y-3">
                                <p class="text-sm text-[var(--text-secondary)]">Carregando análise...</p>
                            </div>
                        </div>

                        <!-- History -->
                        <div class="glass-panel p-6 no-print">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-black text-xs uppercase text-electric-500">Histórico de Fechamentos</h4>
                                <button onclick="App.clearHistory()" class="text-[10px] font-black uppercase bg-[var(--bg-tertiary)] hover:bg-red-50 hover:text-red-500 px-3 py-1.5 rounded-lg transition-all">
                                    Limpar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="text-[10px] uppercase text-[var(--text-secondary)] border-b border-[var(--border-subtle)]">
                                        <tr>
                                            <th class="text-left py-3">Data</th>
                                            <th class="text-right py-3">Vendas</th>
                                            <th class="text-right py-3">Custos</th>
                                            <th class="text-right py-3">Lucro</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-history" class="text-sm font-bold divide-y divide-[var(--border-subtle)]">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Side Panel -->
                    <div class="space-y-6 no-print">
                        <div class="glass-panel p-8 bg-gradient-to-br from-navy-900 to-navy-800 text-white">
                            <h4 class="font-black text-[10px] mb-6 text-[var(--text-secondary)] uppercase">Venda Manual (Dinheiro)</h4>
                            <div class="relative">
                                <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl font-black text-navy-400">R$</span>
                                <input type="number" id="manual-sale" class="w-full bg-transparent border-b-2 border-navy-700 text-4xl font-black text-white outline-none pl-10 pb-2 focus:border-electric-500 tabular-nums" placeholder="0,00">
                            </div>
                            <button onclick="Sales.addManualSale()" class="w-full bg-electric-600 hover:bg-electric-500 py-4 mt-6 rounded-xl font-black uppercase text-xs tracking-widest transition-all">
                                Somar ao Caixa
                            </button>
                        </div>

                        <div class="glass-panel p-6">
                            <h4 class="font-black text-[10px] text-[var(--text-secondary)] mb-4 uppercase">Meta Mensal (Break-Even)</h4>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-[var(--text-secondary)]">R$</span>
                                    <input type="number" id="input-meta" class="w-full bg-[var(--bg-tertiary)] pl-8 p-4 rounded-xl text-sm font-bold border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Ex: 5000">
                                </div>
                                <button onclick="App.saveMeta()" class="bg-navy-900 text-white px-6 rounded-xl font-black text-[10px] uppercase hover:bg-navy-800 transition-colors">
                                    Salvar
                                </button>
                            </div>
                            <p class="text-[10px] text-[var(--text-secondary)] mt-2">Define o ponto de equilíbrio mensal</p>
                        </div>

                        <!-- Quick Stats -->
                        <div class="glass-panel p-6">
                            <h4 class="font-black text-[10px] text-[var(--text-secondary)] mb-4 uppercase">Estatísticas Rápidas</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center py-2 border-b border-[var(--border-subtle)]">
                                    <span class="text-xs text-[var(--text-secondary)]">Ticket Médio</span>
                                    <span id="quick-avg-ticket" class="text-sm font-black">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-[var(--border-subtle)]">
                                    <span class="text-xs text-[var(--text-secondary)]">Produtos Ativos</span>
                                    <span id="quick-active-products" class="text-sm font-black">0</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-xs text-[var(--text-secondary)]">Margem Média</span>
                                    <span id="quick-avg-margin" class="text-sm font-black text-emerald-600">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Backup Quick Action -->
                        <div class="glass-panel p-6 backup-card cursor-pointer hover:shadow-lg transition-all" onclick="Backup.openModal()">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-8 h-8 bg-backup-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-cloud-upload-alt text-white text-sm"></i>
                                </div>
                                <h4 class="font-black text-[10px] text-backup-600 uppercase">Backup Imediato</h4>
                            </div>
                            <p class="text-xs text-[var(--text-secondary)] mb-3">Proteja seus dados agora mesmo</p>
                            <button class="w-full bg-backup-600 text-white py-2 rounded-lg font-bold text-[10px] uppercase hover:bg-backup-500 transition-all">
                                <i class="fas fa-download mr-1"></i> Exportar Agora
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INVENTORY SECTION -->
            <div id="section-inventory" class="hidden space-y-8 animate-fade-in">
                <div class="glass-panel p-8 no-print">
                    <h4 class="font-black mb-8 uppercase text-xs text-electric-500 tracking-widest">Cadastro de Estoque</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <input type="text" id="inv-name" class="w-full p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Nome do Insumo">
                        <div class="flex gap-2">
                            <input type="number" id="inv-qty" class="p-4 bg-[var(--bg-tertiary)] rounded-xl w-full font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Quantidade">
                            <select id="inv-unit" class="p-4 bg-[var(--bg-tertiary)] rounded-xl text-[10px] font-black uppercase border border-[var(--border-subtle)] outline-none">
                                <option value="kg">KG</option>
                                <option value="L">L</option>
                                <option value="un">UN</option>
                            </select>
                        </div>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-xs font-bold text-[var(--text-secondary)]">R$</span>
                            <input type="number" id="inv-price" class="w-full p-4 pl-8 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Preço Total">
                        </div>
                        <button onclick="Inventory.add()" class="w-full h-[58px] bg-electric-600 text-white font-black rounded-xl text-[10px] uppercase tracking-widest shadow-lg hover:bg-electric-500 transition-all">
                            Cadastrar
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="grid-inventory">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- RECIPES SECTION COM ANÁLISE IA EM TEMPO REAL -->
            <div id="section-recipes" class="hidden space-y-8 animate-fade-in">
                
                <!-- AI Real-time Analysis Panel -->
                <div id="ai-recipe-panel" class="glass-panel p-6 ai-card no-print animate-fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-ai-500 to-ai-600 rounded-lg flex items-center justify-center ai-glow">
                                <i class="fas fa-brain text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-black text-sm uppercase text-ai-600">Análise em Tempo Real</h4>
                                <p class="text-[10px] text-[var(--text-secondary)]">Cálculos dinâmicos conforme você digita</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="relative flex h-3 w-3">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-ai-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-ai-500"></span>
                            </span>
                            <span class="text-[10px] font-bold text-ai-600 uppercase">Analisando...</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white/50 dark:bg-navy-900/50 p-4 rounded-xl border border-ai-500/20">
                            <p class="text-[9px] font-black uppercase text-[var(--text-secondary)] mb-1">Custo Total</p>
                            <p id="ai-cost-total" class="text-2xl font-black text-red-500 tabular-nums">R$ 0,00</p>
                        </div>
                        <div class="bg-white/50 dark:bg-navy-900/50 p-4 rounded-xl border border-ai-500/20">
                            <p class="text-[9px] font-black uppercase text-[var(--text-secondary)] mb-1">Preço Sugerido</p>
                            <p id="ai-suggested-price" class="text-2xl font-black text-ai-600 tabular-nums">R$ 0,00</p>
                            <p class="text-[9px] text-ai-500 mt-1">Margem 60%</p>
                        </div>
                        <div class="bg-white/50 dark:bg-navy-900/50 p-4 rounded-xl border border-ai-500/20">
                            <p class="text-[9px] font-black uppercase text-[var(--text-secondary)] mb-1">Margem Atual</p>
                            <p id="ai-current-margin" class="text-2xl font-black text-emerald-600 tabular-nums">0%</p>
                            <div class="w-full bg-gray-200 h-1.5 mt-2 rounded-full overflow-hidden">
                                <div id="ai-margin-bar" class="bg-emerald-500 h-full w-0 transition-all duration-500"></div>
                            </div>
                        </div>
                        <div class="bg-white/50 dark:bg-navy-900/50 p-4 rounded-xl border border-ai-500/20">
                            <p class="text-[9px] font-black uppercase text-[var(--text-secondary)] mb-1">Rentabilidade</p>
                            <p id="ai-rentability" class="text-lg font-black text-amber-600">--</p>
                            <p id="ai-rentability-text" class="text-[9px] text-[var(--text-secondary)] mt-1">Aguardando dados</p>
                        </div>
                    </div>

                    <!-- Ingredient Cost Breakdown -->
                    <div id="ai-ingredient-analysis" class="space-y-2 mb-4">
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">Análise por Insumo</p>
                        <div class="text-sm text-[var(--text-secondary)] italic">Adicione ingredientes para ver a análise detalhada...</div>
                    </div>

                    <!-- AI Suggestions -->
                    <div id="ai-suggestions" class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-robot text-amber-600 mt-0.5"></i>
                            <div>
                                <p class="text-xs font-black text-amber-800 dark:text-amber-200 uppercase mb-1">Sugestões da IA</p>
                                <ul id="ai-suggestions-list" class="text-xs text-amber-700 dark:text-amber-300 space-y-1">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recipe Builder -->
                <div class="glass-panel p-8 no-print">
                    <h4 class="font-black mb-8 uppercase text-xs text-electric-500 tracking-widest">Montagem de Receitas</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <input type="text" id="rec-name" class="p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Nome do Produto Final" oninput="AI.analyzeRecipe()">
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-xs font-bold text-[var(--text-secondary)]">R$</span>
                            <input type="number" id="rec-price" class="w-full p-4 pl-8 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Preço de Venda" oninput="AI.analyzeRecipe()">
                        </div>
                    </div>
                    <div class="p-6 bg-electric-50 rounded-2xl mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="select-ing" class="p-4 bg-white rounded-xl text-sm font-bold border border-electric-200 outline-none focus:border-electric-500">
                                <option value="">Selecionar Insumo...</option>
                            </select>
                            <div class="flex gap-2">
                                <input type="number" id="ing-qty" class="p-4 bg-white rounded-xl w-full text-sm font-bold border border-electric-200 outline-none focus:border-electric-500" placeholder="Qtd">
                                <select id="ing-unit" class="p-4 bg-white rounded-xl text-[10px] font-black uppercase border border-electric-200 outline-none">
                                    <option value="g">g</option>
                                    <option value="ml">ml</option>
                                    <option value="un">un</option>
                                </select>
                            </div>
                            <button onclick="Recipes.addIng()" class="bg-electric-600 text-white rounded-xl font-black text-[10px] uppercase hover:bg-electric-500 transition-all">
                                Vincular
                            </button>
                        </div>
                        <div id="list-temp-ing" class="mt-4 flex flex-wrap gap-2"></div>
                    </div>
                    <button onclick="Recipes.save()" class="w-full py-5 bg-navy-900 text-white rounded-xl font-black uppercase text-xs tracking-widest shadow-xl hover:bg-navy-800 transition-all">
                        Salvar Produto
                    </button>
                </div>

                <!-- Recipe Comparison Tool -->
                <div class="glass-panel p-6 no-print">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="font-black text-xs uppercase text-ai-500 tracking-widest flex items-center gap-2">
                            <i class="fas fa-balance-scale"></i> Comparador de Receitas
                        </h4>
                        <button onclick="AI.compareRecipes()" class="text-[10px] bg-ai-500 text-white px-4 py-2 rounded-lg font-bold uppercase hover:bg-ai-600 transition-all">
                            Atualizar Comparação
                        </button>
                    </div>
                    <div id="recipe-comparison-chart" class="h-64">
                        <canvas id="chart-comparison"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="grid-recipes">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- ANALYTICS SECTION -->
            <div id="section-analytics" class="hidden space-y-8 animate-fade-in">
                <div class="glass-panel p-8">
                    <h4 class="font-black text-xl uppercase mb-6 text-ai-600 tracking-widest flex items-center gap-3">
                        <i class="fas fa-chart-pie"></i> Dashboard Analítico Avançado
                    </h4>
                    
                    <!-- Advanced Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="glass-panel p-6 text-center border-t-4 border-ai-500">
                            <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">ROI Médio</p>
                            <h3 id="analytics-roi" class="text-3xl font-black text-ai-600">0%</h3>
                            <p class="text-[10px] text-[var(--text-secondary)] mt-1">Retorno sobre investimento</p>
                        </div>
                        <div class="glass-panel p-6 text-center border-t-4 border-emerald-500">
                            <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">Taxa de Conversão</p>
                            <h3 id="analytics-conversion" class="text-3xl font-black text-emerald-600">0%</h3>
                            <p class="text-[10px] text-[var(--text-secondary)] mt-1">Visitantes vs Vendas</p>
                        </div>
                        <div class="glass-panel p-6 text-center border-t-4 border-amber-500">
                            <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">Ponto de Equilíbrio</p>
                            <h3 id="analytics-breakeven" class="text-3xl font-black text-amber-600">0</h3>
                            <p class="text-[10px] text-[var(--text-secondary)] mt-1">Unidades/dia necessárias</p>
                        </div>
                        <div class="glass-panel p-6 text-center border-t-4 border-red-500">
                            <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">Custo de Aquisição</p>
                            <h3 id="analytics-cac" class="text-3xl font-black text-red-500">R$ 0,00</h3>
                            <p class="text-[10px] text-[var(--text-secondary)] mt-1">Por cliente</p>
                        </div>
                    </div>

                    <!-- Detailed Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="glass-panel p-6">
                            <h5 class="font-black text-xs uppercase mb-4 text-[var(--text-secondary)]">Evolução de Margens por Produto</h5>
                            <div class="h-64"><canvas id="chart-margins"></canvas></div>
                        </div>
                        <div class="glass-panel p-6">
                            <h5 class="font-black text-xs uppercase mb-4 text-[var(--text-secondary)]">Projeção de Crescimento (IA)</h5>
                            <div class="h-64"><canvas id="chart-projection"></canvas></div>
                        </div>
                    </div>

                    <!-- ABC Analysis -->
                    <div class="glass-panel p-6">
                        <h5 class="font-black text-xs uppercase mb-6 text-ai-600 flex items-center gap-2">
                            <i class="fas fa-sort-amount-down"></i> Análise ABC - Curva de Pareto
                        </h5>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-[var(--bg-tertiary)] text-[var(--text-secondary)] font-black text-[10px] uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Classificação</th>
                                        <th class="px-4 py-3 text-left">Produto</th>
                                        <th class="px-4 py-3 text-right">Faturamento</th>
                                        <th class="px-4 py-3 text-right">% do Total</th>
                                        <th class="px-4 py-3 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="abc-analysis-body" class="divide-y divide-[var(--border-subtle)]">
                                    <!-- Populated by AI -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Auto-Backup Indicator -->
    <div id="auto-backup-indicator" class="backup-status hidden">
        <div class="glass-panel p-4 bg-backup-500 text-white rounded-xl shadow-lg flex items-center gap-3 animate-slide-up">
            <i class="fas fa-sync-alt sync-indicator"></i>
            <div>
                <p class="text-xs font-black uppercase">Backup Automático</p>
                <p class="text-[10px] opacity-90">Salvando dados...</p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STORE - ESTADO CENTRALIZADO (ORIGINAL PRESERVADO)
        // ==========================================
        
        const Store = {
            data: {
                license: '',
                storeDoc: '',
                firstAccessDate: null,
                inventory: {},
                recipes: {},
                dailyUsage: [],
                dailySales: 0,
                fixedCost: 0,
                currentFixedLeft: 0,
                historyLog: [],
                salesHistory: [],
                productPerformance: {},
                // Novos campos para backup
                lastBackup: null,
                backupHistory: []
            },

            init() {
                const saved = localStorage.getItem('GP_V80_AI');
                if (saved) {
                    this.data = JSON.parse(saved);
                }
            },

            save() {
                localStorage.setItem('GP_V80_AI', JSON.stringify(this.data));
                // Dispara evento para backup automático
                window.dispatchEvent(new CustomEvent('dataChanged'));
            },

            clear() {
                localStorage.removeItem('GP_V80_AI');
                location.reload();
            },

            getDaysRemaining() {
                if (!this.data.firstAccessDate) return 365;
                
                const firstAccess = new Date(this.data.firstAccessDate);
                const now = new Date();
                const diffTime = now - firstAccess;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const remaining = 365 - diffDays;
                
                return Math.max(0, remaining);
            },

            isExpired() {
                return this.getDaysRemaining() <= 0;
            },

            getInventory(name) { 
                return this.data.inventory[name]; 
            },
            
            setInventory(name, data) {
                this.data.inventory[name] = data;
                this.save();
            },

            deleteInventory(name) {
                delete this.data.inventory[name];
                this.save();
            },

            getRecipe(name) {
                return this.data.recipes[name];
            },

            setRecipe(name, data) {
                this.data.recipes[name] = data;
                this.save();
            },

            deleteRecipe(name) {
                delete this.data.recipes[name];
                this.save();
            },

            addUsage(usage) {
                this.data.dailyUsage.push({
                    ...usage,
                    id: Date.now(),
                    time: new Date().toLocaleTimeString('pt-BR')
                });
                this.save();
            },

            removeUsage(id) {
                this.data.dailyUsage = this.data.dailyUsage.filter(u => u.id !== id);
                this.save();
            },

            addSale(value, productName = null) {
                this.data.dailySales += value;
                if (productName) {
                    if (!this.data.productPerformance[productName]) {
                        this.data.productPerformance[productName] = { sales: 0, quantity: 0, revenue: 0 };
                    }
                    this.data.productPerformance[productName].sales++;
                    this.data.productPerformance[productName].revenue += value;
                }
                this.save();
            },

            closeDay() {
                const totalCost = this.data.dailyUsage.reduce((a, b) => a + (b.cost || 0), 0);
                const profit = this.data.dailySales - totalCost;
                
                this.data.historyLog.unshift({
                    date: new Date().toLocaleDateString('pt-BR'),
                    sales: this.data.dailySales,
                    costs: totalCost,
                    profit: profit,
                    timestamp: Date.now()
                });

                this.data.salesHistory.push({
                    date: new Date().toISOString(),
                    sales: this.data.dailySales,
                    costs: totalCost,
                    profit: profit
                });

                this.data.currentFixedLeft = (this.data.currentFixedLeft || this.data.fixedCost) - profit;
                this.data.dailySales = 0;
                this.data.dailyUsage = [];
                this.save();
            },

            clearHistory() {
                this.data.historyLog = [];
                this.data.salesHistory = [];
                this.save();
            },

            setMeta(value) {
                this.data.fixedCost = value;
                this.data.currentFixedLeft = value;
                this.save();
            },

            getMonthlyStats() {
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const recent = this.data.historyLog.filter(h => h.timestamp > thirtyDaysAgo);
                return recent.reduce((acc, h) => ({
                    sales: acc.sales + h.sales,
                    costs: acc.costs + h.costs,
                    profit: acc.profit + h.profit
                }), { sales: 0, costs: 0, profit: 0 });
            },

            formatMoney(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value || 0);
            },

            // Métodos de backup
            recordBackup(type = 'manual') {
                this.data.lastBackup = new Date().toISOString();
                this.data.backupHistory.unshift({
                    date: new Date().toISOString(),
                    type: type,
                    size: JSON.stringify(this.data).length
                });
                // Mantém apenas últimos 10 registros
                this.data.backupHistory = this.data.backupHistory.slice(0, 10);
                this.save();
            },

            getDataSize() {
                const bytes = JSON.stringify(this.data).length;
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            },

            getRecordsCount() {
                return Object.keys(this.data.inventory).length + 
                       Object.keys(this.data.recipes).length + 
                       this.data.historyLog.length;
            }
        };

        // ==========================================
        // BACKUP & SYNC MODULE - NOVO
        // ==========================================

        const Backup = {
            autoBackupInterval: null,

            init() {
                // Configura backup automático a cada 5 minutos
                this.autoBackupInterval = setInterval(() => {
                    this.autoBackup();
                }, 5 * 60 * 1000); // 5 minutos

                // Escuta mudanças nos dados
                window.addEventListener('dataChanged', () => {
                    this.updateWidget();
                });

                this.updateWidget();
            },

            autoBackup() {
                // Mostra indicador
                const indicator = document.getElementById('auto-backup-indicator');
                indicator.classList.remove('hidden');
                
                // Simula processo de backup
                setTimeout(() => {
                    Store.recordBackup('auto');
                    indicator.classList.add('hidden');
                    console.log('Backup automático realizado:', new Date().toLocaleString());
                }, 1500);
            },

            updateWidget() {
                const lastBackup = Store.data.lastBackup;
                const widgetText = document.getElementById('backup-widget-text');
                const syncStatus = document.getElementById('backup-sync-status');
                
                if (lastBackup) {
                    const date = new Date(lastBackup);
                    const diff = (new Date() - date) / 1000 / 60; // minutos
                    
                    let timeText;
                    if (diff < 1) timeText = 'agora mesmo';
                    else if (diff < 60) timeText = `há ${Math.floor(diff)} min`;
                    else if (diff < 1440) timeText = `há ${Math.floor(diff / 60)} h`;
                    else timeText = `há ${Math.floor(diff / 1440)} dias`;
                    
                    widgetText.textContent = `Último: ${timeText} • Clique para gerenciar`;
                    syncStatus.innerHTML = '<i class="fas fa-check-circle"></i> Protegido';
                    syncStatus.className = 'text-[10px] font-bold text-emerald-600 flex items-center gap-1';
                } else {
                    widgetText.textContent = 'Nunca backupado • Clique para proteger';
                    syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Pendente';
                    syncStatus.className = 'text-[10px] font-bold text-amber-600 flex items-center gap-1';
                }

                // Atualiza modal se estiver aberto
                this.updateModalStats();
            },

            openModal() {
                this.updateModalStats();
                this.renderBackupHistory();
                UI.showModal('backup-modal');
            },

            updateModalStats() {
                const sizeEl = document.getElementById('backup-size');
                const recordsEl = document.getElementById('backup-records');
                const lastTimeEl = document.getElementById('backup-last-time');
                
                if (sizeEl) sizeEl.textContent = Store.getDataSize();
                if (recordsEl) recordsEl.textContent = Store.getRecordsCount() + ' itens';
                if (lastTimeEl) {
                    lastTimeEl.textContent = Store.data.lastBackup ? 
                        new Date(Store.data.lastBackup).toLocaleString('pt-BR') : 'Nunca';
                }
            },

            renderBackupHistory() {
                const container = document.getElementById('backup-history-list');
                const history = Store.data.backupHistory || [];
                
                if (history.length === 0) {
                    container.innerHTML = '<p class="text-sm text-[var(--text-secondary)] text-center py-4">Nenhum backup registrado</p>';
                    return;
                }

                container.innerHTML = history.map((b, i) => {
                    const date = new Date(b.date);
                    const size = b.size < 1024 ? b.size + ' B' : 
                                b.size < 1024 * 1024 ? (b.size / 1024).toFixed(1) + ' KB' : 
                                (b.size / (1024 * 1024)).toFixed(1) + ' MB';
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-[var(--bg-tertiary)] rounded-lg text-xs">
                            <div class="flex items-center gap-3">
                                <i class="fas ${b.type === 'auto' ? 'fa-sync text-blue-500' : 'fa-user text-emerald-500'}"></i>
                                <div>
                                    <p class="font-bold">${b.type === 'auto' ? 'Automático' : 'Manual'}</p>
                                    <p class="text-[10px] text-[var(--text-secondary)]">${date.toLocaleString('pt-BR')}</p>
                                </div>
                            </div>
                            <span class="font-mono text-[10px]">${size}</span>
                        </div>
                    `;
                }).join('');
            },

            // Exportar para arquivo JSON
            exportToFile() {
                const dataStr = JSON.stringify(Store.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `GP_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                Store.recordBackup('manual');
                this.updateWidget();
                this.renderBackupHistory();
                UI.showToast('Backup exportado com sucesso!', 'success');
            },

            // Importar de arquivo
            importFromFile(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.processImport(data);
                    } catch (err) {
                        UI.showToast('Arquivo inválido ou corrompido', 'error');
                    }
                };
                reader.readAsText(file);
                input.value = ''; // Reset input
            },

            // Gerar código de transferência (compactado)
            generateShareCode() {
                const dataStr = JSON.stringify(Store.data);
                // Compactação simples com Base64
                const encoded = btoa(unescape(encodeURIComponent(dataStr)));
                
                // Divide em chunks para facilitar cópia
                const chunks = encoded.match(/.{1,50}/g) || [];
                const formatted = chunks.join('\n');
                
                document.getElementById('transfer-code-display').textContent = formatted;
                document.getElementById('transfer-code-section').classList.remove('hidden');
                
                Store.recordBackup('manual');
                this.updateWidget();
            },

            hideTransferCode() {
                document.getElementById('transfer-code-section').classList.add('hidden');
            },

            copyTransferCode() {
                const code = document.getElementById('transfer-code-display').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    UI.showToast('Código copiado! Cole no outro dispositivo.', 'success');
                });
            },

            // Importar de código
            importFromCode() {
                const input = document.getElementById('import-code-input');
                const code = input.value.replace(/\s/g, ''); // Remove espaços/quebras
                
                if (!code) {
                    UI.showToast('Cole o código primeiro', 'error');
                    return;
                }

                try {
                    const decoded = decodeURIComponent(escape(atob(code)));
                    const data = JSON.parse(decoded);
                    this.processImport(data);
                    input.value = '';
                    UI.hideModal('backup-modal');
                } catch (err) {
                    UI.showToast('Código inválido ou incompleto', 'error');
                    console.error(err);
                }
            },

            // Processar importação (usado por arquivo ou código)
            processImport(data) {
                // Validação básica
                if (!data || typeof data !== 'object') {
                    UI.showToast('Dados inválidos', 'error');
                    return;
                }

                // Confirmação
                const stats = {
                    inventory: Object.keys(data.inventory || {}).length,
                    recipes: Object.keys(data.recipes || {}).length,
                    history: (data.historyLog || []).length
                };

                const msg = `Restaurar backup?\n\n` +
                           `• ${stats.inventory} insumos\n` +
                           `• ${stats.recipes} receitas\n` +
                           `• ${stats.history} registros de histórico\n\n` +
                           `⚠️ Isso substituirá todos os dados atuais!`;

                if (!confirm(msg)) return;

                // Preserva licença atual se existir
                const currentLicense = Store.data.license;
                const currentDoc = Store.data.storeDoc;
                const currentFirstAccess = Store.data.firstAccessDate;

                // Restaura dados
                Store.data = {
                    ...data,
                    license: currentLicense || data.license,
                    storeDoc: currentDoc || data.storeDoc,
                    firstAccessDate: currentFirstAccess || data.firstAccessDate,
                    lastBackup: new Date().toISOString()
                };

                Store.save();
                location.reload(); // Recarrega para aplicar tudo
            },

            // Enviar por WhatsApp (código curto)
            exportToWhatsApp() {
                const dataStr = JSON.stringify(Store.data);
                const encoded = btoa(unescape(encodeURIComponent(dataStr)));
                
                // Gera código curto (primeiros 500 chars + hash)
                const shortCode = encoded.substring(0, 500);
                const hash = this.simpleHash(encoded).toString(36);
                
                const msg = `🚀 *BACKUP GESTÃO PRO*\n\n` +
                           `Código de restauração (Parte 1/${Math.ceil(encoded.length/500)}):\n\n` +
                           `\`\`\`${shortCode}\`\`\`\n\n` +
                           `Hash: ${hash}\n` +
                           `Data: ${new Date().toLocaleString('pt-BR')}\n\n` +
                           `Para restaurar, copie o código completo e use "Importar por Código" no sistema.`;
                
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
                Store.recordBackup('manual');
            },

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash);
            },

            // Limpar histórico
            clearHistory() {
                if (!confirm('Limpar histórico de backups?')) return;
                Store.data.backupHistory = [];
                Store.save();
                this.renderBackupHistory();
                UI.showToast('Histórico limpo');
            },

            // Modal de restauração (tela de login)
            showRestoreModal() {
                UI.showModal('restore-modal');
            },

            restoreFromCode() {
                const input = document.getElementById('restore-code-input');
                const code = input.value.replace(/\s/g, '');
                
                if (!code) {
                    UI.showToast('Cole o código primeiro', 'error');
                    return;
                }

                try {
                    const decoded = decodeURIComponent(escape(atob(code)));
                    const data = JSON.parse(decoded);
                    this.processImport(data);
                    UI.hideModal('restore-modal');
                } catch (err) {
                    UI.showToast('Código inválido', 'error');
                }
            },

            restoreFromFile(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.processImport(data);
                        UI.hideModal('restore-modal');
                    } catch (err) {
                        UI.showToast('Arquivo inválido', 'error');
                    }
                };
                reader.readAsText(file);
            }
        };

        // ==========================================
        // AI ANALYTICS MODULE
        // ==========================================

        const AI = {
            analyzeRecipe() {
                const name = document.getElementById('rec-name').value;
                const price = parseFloat(document.getElementById('rec-price').value) || 0;
                
                let totalCost = 0;
                const ingredientAnalysis = [];

                Recipes.tempIngredients.forEach(ing => {
                    const item = Store.getInventory(ing.name);
                    if (item) {
                        let baseQty = ing.qty;
                        if (ing.unit === 'kg' || ing.unit === 'L') baseQty *= 1000;
                        
                        const cost = baseQty * item.pricePerBase;
                        totalCost += cost;
                        
                        ingredientAnalysis.push({
                            name: ing.name,
                            qty: ing.qty,
                            unit: ing.unit,
                            cost: cost,
                            stock: item.stock,
                            stockUnit: item.unit
                        });
                    }
                });

                document.getElementById('ai-cost-total').textContent = Store.formatMoney(totalCost);
                
                const suggestedPrice = totalCost * 2.5;
                document.getElementById('ai-suggested-price').textContent = Store.formatMoney(suggestedPrice);

                let margin = 0;
                if (price > 0 && totalCost > 0) {
                    margin = ((price - totalCost) / price) * 100;
                }
                
                const marginEl = document.getElementById('ai-current-margin');
                marginEl.textContent = margin.toFixed(1) + '%';
                marginEl.className = `text-2xl font-black tabular-nums ${margin >= 60 ? 'text-emerald-600' : margin >= 40 ? 'text-amber-600' : 'text-red-500'}`;
                
                const marginBar = document.getElementById('ai-margin-bar');
                marginBar.style.width = Math.min(100, Math.max(0, margin)) + '%';
                marginBar.className = `h-full transition-all duration-500 ${margin >= 60 ? 'bg-emerald-500' : margin >= 40 ? 'bg-amber-500' : 'bg-red-500'}`;

                const profit = price - totalCost;
                const rentabilityEl = document.getElementById('ai-rentability');
                const rentabilityText = document.getElementById('ai-rentability-text');
                
                if (profit > 0) {
                    if (margin >= 60) {
                        rentabilityEl.textContent = 'EXCELENTE';
                        rentabilityEl.className = 'text-lg font-black text-emerald-600';
                        rentabilityText.textContent = 'Margem acima do mercado';
                    } else if (margin >= 40) {
                        rentabilityEl.textContent = 'BOA';
                        rentabilityEl.className = 'text-lg font-black text-amber-600';
                        rentabilityText.textContent = 'Margem competitiva';
                    } else {
                        rentabilityEl.textContent = 'BAIXA';
                        rentabilityEl.className = 'text-lg font-black text-red-500';
                        rentabilityText.textContent = 'Abaixo do ideal (60%)';
                    }
                } else {
                    rentabilityEl.textContent = 'PREJUÍZO';
                    rentabilityEl.className = 'text-lg font-black text-red-600';
                    rentabilityText.textContent = 'Preço abaixo do custo!';
                }

                this.renderIngredientAnalysis(ingredientAnalysis, totalCost);
                this.generateSuggestions(totalCost, price, margin, ingredientAnalysis);
            },

            renderIngredientAnalysis(analysis, totalCost) {
                const container = document.getElementById('ai-ingredient-analysis');
                
                if (analysis.length === 0) {
                    container.innerHTML = `
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">Análise por Insumo</p>
                        <div class="text-sm text-[var(--text-secondary)] italic">Adicione ingredientes para ver a análise detalhada...</div>
                    `;
                    return;
                }

                let html = '<p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">Análise por Insumo</p><div class="space-y-2">';
                
                analysis.forEach(ing => {
                    const percentage = totalCost > 0 ? (ing.cost / totalCost * 100) : 0;
                    const isCritical = ing.stock < (ing.qty * 10);
                    
                    html += `
                        <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-navy-900/50 rounded-lg border ${isCritical ? 'border-red-300 bg-red-50' : 'border-[var(--border-subtle)]'}">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-xs">${ing.name}</span>
                                    ${isCritical ? '<i class="fas fa-exclamation-triangle text-red-500 text-xs" title="Estoque crítico"></i>' : ''}
                                </div>
                                <div class="text-[10px] text-[var(--text-secondary)] mt-0.5">
                                    ${ing.qty}${ing.unit} × ${Store.formatMoney(ing.cost / (ing.unit === 'kg' || ing.unit === 'L' ? ing.qty * 1000 : ing.qty))} = ${Store.formatMoney(ing.cost)}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-black ${percentage > 50 ? 'text-red-500' : 'text-[var(--text-primary)]'}">${percentage.toFixed(1)}%</div>
                                <div class="w-16 bg-gray-200 h-1 rounded-full mt-1">
                                    <div class="${percentage > 50 ? 'bg-red-500' : 'bg-ai-500'} h-full rounded-full" style="width: ${Math.min(100, percentage)}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },

            generateSuggestions(totalCost, price, margin, ingredients) {
                const suggestionsDiv = document.getElementById('ai-suggestions');
                const list = document.getElementById('ai-suggestions-list');
                const suggestions = [];

                if (totalCost === 0) {
                    suggestionsDiv.classList.add('hidden');
                    return;
                }

                if (margin < 40) {
                    suggestions.push(`A margem de ${margin.toFixed(1)}% está abaixo do ideal. Considere aumentar o preço para ${Store.formatMoney(totalCost * 2.5)} (60% margem)`);
                } else if (margin > 80) {
                    suggestions.push(`Margem muito alta (${margin.toFixed(1)}%). Verifique se o preço está competitivo.`);
                }

                ingredients.forEach(ing => {
                    const percentage = totalCost > 0 ? (ing.cost / totalCost * 100) : 0;
                    if (percentage > 50) {
                        suggestions.push(`"${ing.name}" representa ${percentage.toFixed(0)}% do custo. Avalie reduzir quantidade ou negociar preço.`);
                    }
                    if (ing.stock < (ing.qty * 5)) {
                        suggestions.push(`Estoque de "${ing.name}" está crítico. Reposição necessária em breve.`);
                    }
                });

                const suggestedPrice = totalCost * 2.5;
                if (price > 0 && Math.abs(price - suggestedPrice) / suggestedPrice > 0.2) {
                    if (price < suggestedPrice) {
                        suggestions.push(`Preço atual ${Store.formatMoney(price)} está ${((suggestedPrice - price) / suggestedPrice * 100).toFixed(0)}% abaixo do sugerido.`);
                    }
                }

                if (suggestions.length > 0) {
                    list.innerHTML = suggestions.map(s => `<li class="flex items-start gap-2"><i class="fas fa-check text-amber-600 mt-0.5 text-[10px]"></i><span>${s}</span></li>`).join('');
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            },

            generatePredictions() {
                const history = Store.data.historyLog.slice(0, 30);
                if (history.length < 3) return;

                const recent = history.slice(0, 3);
                const avgSales = recent.reduce((a, b) => a + b.sales, 0) / 3;
                
                const trend = history[0].sales > history[1].sales ? 'up' : 'down';
                const trendEl = document.getElementById('trend-indicator');
                if (trendEl) {
                    trendEl.textContent = trend === 'up' ? 'Crescente 📈' : 'Decrescente 📉';
                    trendEl.className = trend === 'up' ? 'text-emerald-600 font-bold' : 'text-red-500 font-bold';
                }

                const predictionEl = document.getElementById('ai-prediction-sales');
                if (predictionEl) {
                    predictionEl.textContent = Store.formatMoney(avgSales * 1.05);
                }

                let criticalStock = 0;
                Object.entries(Store.data.inventory).forEach(([name, item]) => {
                    const dailyUsage = Store.data.dailyUsage
                        .filter(u => u.name === name)
                        .reduce((a, b) => a + b.qty, 0);
                    
                    if (dailyUsage > 0) {
                        const daysLeft = item.stock / dailyUsage;
                        if (daysLeft < 3) criticalStock++;
                    }
                });
                
                const stockAlertEl = document.getElementById('ai-stock-alert');
                if (stockAlertEl) {
                    stockAlertEl.textContent = criticalStock + ' itens';
                    stockAlertEl.className = `text-2xl font-black ${criticalStock > 0 ? 'text-red-500' : 'text-emerald-600'}`;
                }

                const products = Object.entries(Store.data.productPerformance);
                if (products.length > 0) {
                    const topProduct = products.sort((a, b) => b[1].revenue - a[1].revenue)[0];
                    const topEl = document.getElementById('ai-top-product');
                    const marginEl = document.getElementById('ai-top-product-margin');
                    
                    if (topEl) {
                        topEl.textContent = topProduct[0];
                        const recipe = Store.getRecipe(topProduct[0]);
                        if (recipe) {
                            const cost = this.calculateRecipeCost(recipe);
                            const margin = ((recipe.price - cost) / recipe.price * 100);
                            marginEl.textContent = `Margem: ${margin.toFixed(1)}%`;
                        }
                    }
                }

                this.generateDashboardRecommendations();
            },

            calculateRecipeCost(recipe) {
                let cost = 0;
                recipe.ingredients.forEach(ing => {
                    const item = Store.getInventory(ing.name);
                    if (item) {
                        let qty = ing.qty;
                        if (ing.unit === 'kg' || ing.unit === 'L') qty *= 1000;
                        cost += qty * item.pricePerBase;
                    }
                });
                return cost;
            },

            generateDashboardRecommendations() {
                const container = document.getElementById('ai-recommendations');
                if (!container) return;

                const recs = [];
                const monthly = Store.getMonthlyStats();

                if (monthly.sales > 0) {
                    const avgTicket = monthly.sales / (Store.data.historyLog.length || 1);
                    if (avgTicket < 50) {
                        recs.push('Considere criar combos para aumentar o ticket médio.');
                    }
                }

                const lowStock = Object.entries(Store.data.inventory).filter(([_, item]) => item.stock < 500);
                if (lowStock.length > 0) {
                    recs.push(`${lowStock.length} insumos com estoque crítico necessitam atenção imediata.`);
                }

                const recipes = Object.entries(Store.data.recipes);
                const lowMargin = recipes.filter(([_, r]) => {
                    const cost = this.calculateRecipeCost(r);
                    return ((r.price - cost) / r.price) < 0.4;
                });
                
                if (lowMargin.length > 0) {
                    recs.push(`${lowMargin.length} produtos com margem abaixo de 40%. Reveja precificação.`);
                }

                const hour = new Date().getHours();
                if (hour >= 11 && hour <= 14) {
                    recs.push('Horário de pico detectado. Verifique se há estoque suficiente para demanda.');
                }

                if (recs.length === 0) {
                    recs.push('Tudo certo! Continue monitorando seus indicadores.');
                }

                container.innerHTML = recs.map(r => `
                    <div class="flex items-start gap-3 p-3 bg-white/50 dark:bg-navy-900/30 rounded-lg border border-ai-500/20">
                        <i class="fas fa-robot text-ai-500 mt-0.5"></i>
                        <p class="text-xs text-[var(--text-primary)] leading-relaxed">${r}</p>
                    </div>
                `).join('');
            },

            showInsights() {
                const modal = document.getElementById('ai-insights-modal');
                const content = document.getElementById('ai-content');
                
                const monthly = Store.getMonthlyStats();
                const recipes = Object.entries(Store.data.recipes);
                const inventory = Object.entries(Store.data.inventory);
                
                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-ai-500 to-ai-600 text-white p-6 rounded-2xl">
                            <p class="text-[10px] font-black uppercase opacity-80 mb-1">Performance Mensal</p>
                            <p class="text-3xl font-black">${Store.formatMoney(monthly.profit)}</p>
                            <p class="text-xs mt-2 opacity-90">Lucro líquido estimado</p>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-6 rounded-2xl">
                            <p class="text-[10px] font-black uppercase opacity-80 mb-1">Eficiência</p>
                            <p class="text-3xl font-black">${monthly.sales > 0 ? ((monthly.profit / monthly.sales) * 100).toFixed(1) : 0}%</p>
                            <p class="text-xs mt-2 opacity-90">Margem média operacional</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 text-white p-6 rounded-2xl">
                            <p class="text-[10px] font-black uppercase opacity-80 mb-1">Produtividade</p>
                            <p class="text-3xl font-black">${recipes.length}</p>
                            <p class="text-xs mt-2 opacity-90">Produtos ativos</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="insight-card p-6 rounded-xl">
                            <h5 class="font-black text-sm uppercase mb-4 flex items-center gap-2">
                                <i class="fas fa-lightbulb text-ai-500"></i> Oportunidades Identificadas
                            </h5>
                            <ul class="space-y-3 text-sm">
                                ${this.generateOpportunities()}
                            </ul>
                        </div>

                        <div class="insight-card p-6 rounded-xl border-l-4 border-red-500 bg-red-50 dark:bg-red-900/10">
                            <h5 class="font-black text-sm uppercase mb-4 flex items-center gap-2 text-red-600">
                                <i class="fas fa-exclamation-triangle"></i> Alertas e Riscos
                            </h5>
                            <ul class="space-y-3 text-sm">
                                ${this.generateAlerts()}
                            </ul>
                        </div>

                        <div class="insight-card p-6 rounded-xl border-l-4 border-emerald-500 bg-emerald-50 dark:bg-emerald-900/10">
                            <h5 class="font-black text-sm uppercase mb-4 flex items-center gap-2 text-emerald-600">
                                <i class="fas fa-chart-line"></i> Projeções para Próximo Mês
                            </h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-[10px] uppercase text-[var(--text-secondary)]">Receita Esperada</p>
                                    <p class="text-xl font-black text-emerald-600">${Store.formatMoney(monthly.sales * 1.1)}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase text-[var(--text-secondary)]">Custo Estimado</p>
                                    <p class="text-xl font-black text-red-500">${Store.formatMoney(monthly.costs * 1.05)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
                UI.showModal('ai-insights-modal');
            },

            generateOpportunities() {
                const ops = [];
                const recipes = Object.entries(Store.data.recipes);
                
                const highMargin = recipes.filter(([_, r]) => {
                    const cost = this.calculateRecipeCost(r);
                    return ((r.price - cost) / r.price) > 0.6;
                });
                
                if (highMargin.length > 0) {
                    ops.push(`<li class="flex items-start gap-2"><i class="fas fa-star text-amber-500 mt-1"></i> <span><strong>${highMargin.length} produtos</strong> têm margem excelente (>60%). Considere promovê-los mais intensamente.</span></li>`);
                }

                const hour = new Date().getHours();
                if (hour >= 10 && hour <= 15) {
                    ops.push(`<li class="flex items-start gap-2"><i class="fas fa-clock text-blue-500 mt-1"></i> <span>Horário de pico identificado. Sugestão: criar promoções relâmpago das 11h às 14h para aumentar ticket médio.</span></li>`);
                }

                const slowMoving = Object.entries(Store.data.inventory).filter(([_, item]) => {
                    const usage = Store.data.dailyUsage.filter(u => u.name === _).length;
                    return usage === 0 && item.stock > 1000;
                });
                
                if (slowMoving.length > 0) {
                    ops.push(`<li class="flex items-start gap-2"><i class="fas fa-box text-purple-500 mt-1"></i> <span><strong>${slowMoving.length} insumos</strong> estão parados no estoque. Crie receitas promocionais para utilizá-los.</span></li>`);
                }

                if (ops.length === 0) {
                    ops.push(`<li class="flex items-start gap-2"><i class="fas fa-check-circle text-emerald-500 mt-1"></i> <span>Nenhuma oportunidade crítica identificada no momento. Continue monitorando!</span></li>`);
                }

                return ops.join('');
            },

            generateAlerts() {
                const alerts = [];
                
                const critical = Object.entries(Store.data.inventory).filter(([_, item]) => item.stock < 200);
                if (critical.length > 0) {
                    alerts.push(`<li class="flex items-start gap-2"><i class="fas fa-exclamation-circle text-red-500 mt-1"></i> <span><strong>${critical.length} insumos</strong> com estoque crítico (<200g/ml). Risco de ruptura iminente!</span></li>`);
                }

                const recipes = Object.entries(Store.data.recipes);
                const lossMaking = recipes.filter(([_, r]) => {
                    const cost = this.calculateRecipeCost(r);
                    return r.price <= cost;
                });
                
                if (lossMaking.length > 0) {
                    alerts.push(`<li class="flex items-start gap-2"><i class="fas fa-arrow-down text-red-500 mt-1"></i> <span><strong>${lossMaking.length} produtos</strong> estão sendo vendidos com prejuízo ou sem margem. Ação imediata necessária!</span></li>`);
                }

                if (Store.data.fixedCost > 0) {
                    const progress = ((Store.data.fixedCost - Store.data.currentFixedLeft) / Store.data.fixedCost * 100);
                    if (progress < 30 && Store.data.historyLog.length > 5) {
                        alerts.push(`<li class="flex items-start gap-2"><i class="fas fa-chart-line text-amber-500 mt-1"></i> <span>Progresso toward meta mensal está abaixo de 30%. Acelere as vendas ou revise custos fixos.</span></li>`);
                    }
                }

                if (alerts.length === 0) {
                    alerts.push(`<li class="flex items-start gap-2"><i class="fas fa-shield-alt text-emerald-500 mt-1"></i> <span>Nenhum alerta crítico. Operação saudável!</span></li>`);
                }

                return alerts.join('');
            },

            compareRecipes() {
                const recipes = Object.entries(Store.data.recipes);
                if (recipes.length < 2) {
                    UI.showToast('Cadastre pelo menos 2 receitas para comparar', 'warning');
                    return;
                }

                const ctx = document.getElementById('chart-comparison');
                if (!ctx) return;

                const labels = recipes.map(([name, _]) => name);
                const margins = recipes.map(([_, r]) => {
                    const cost = this.calculateRecipeCost(r);
                    return ((r.price - cost) / r.price * 100).toFixed(1);
                });
                const revenues = recipes.map(([name, _]) => {
                    const perf = Store.data.productPerformance[name];
                    return perf ? perf.revenue : 0;
                });

                if (window.comparisonChart) {
                    window.comparisonChart.destroy();
                }

                window.comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Margem %',
                            data: margins,
                            backgroundColor: 'rgba(139, 92, 246, 0.8)',
                            yAxisID: 'y'
                        }, {
                            label: 'Faturamento',
                            data: revenues,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Margem %' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                title: { display: true, text: 'Faturamento R$' }
                            }
                        }
                    }
                });
            },

            generateABCAnalysis() {
                const tbody = document.getElementById('abc-analysis-body');
                if (!tbody) return;

                const recipes = Object.entries(Store.data.recipes);
                if (recipes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-[var(--text-secondary)]">Nenhum dado disponível</td></tr>';
                    return;
                }

                const productData = recipes.map(([name, recipe]) => {
                    const perf = Store.data.productPerformance[name] || { revenue: 0, quantity: 0 };
                    return {
                        name,
                        revenue: perf.revenue,
                        quantity: perf.quantity,
                        price: recipe.price
                    };
                }).sort((a, b) => b.revenue - a.revenue);

                const totalRevenue = productData.reduce((a, b) => a + b.revenue, 0);
                let accumulated = 0;

                const classified = productData.map(p => {
                    accumulated += p.revenue;
                    const percentage = totalRevenue > 0 ? (p.revenue / totalRevenue * 100) : 0;
                    const accumulatedPct = totalRevenue > 0 ? (accumulated / totalRevenue * 100) : 0;
                    
                    let classificacao = 'C';
                    let color = 'gray';
                    if (accumulatedPct <= 80) { classificacao = 'A'; color = 'emerald'; }
                    else if (accumulatedPct <= 95) { classificacao = 'B'; color = 'amber'; }

                    return { ...p, percentage, accumulatedPct, classificacao, color };
                });

                tbody.innerHTML = classified.map(c => `
                    <tr class="hover:bg-[var(--bg-tertiary)] transition-colors">
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-${c.color}-100 text-${c.color}-700 text-xs font-black">
                                ${c.classificacao}
                            </span>
                        </td>
                        <td class="px-4 py-3 font-bold text-xs">${c.name}</td>
                        <td class="px-4 py-3 text-right font-bold tabular-nums">${Store.formatMoney(c.revenue)}</td>
                        <td class="px-4 py-3 text-right text-xs">${c.percentage.toFixed(1)}%</td>
                        <td class="px-4 py-3 text-center">
                            ${c.classificacao === 'A' ? '<span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-bold">Foco</span>' : 
                              c.classificacao === 'B' ? '<span class="text-[10px] bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-bold">Manter</span>' :
                              '<span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded-full font-bold">Reavaliar</span>'}
                        </td>
                    </tr>
                `).join('');

                const aProducts = classified.filter(c => c.classificacao === 'A').length;
                const conversion = Store.data.historyLog.length > 0 ? 
                    Math.min(100, (Store.data.dailySales / (Store.data.fixedCost / 30) * 100)) : 0;
                
                document.getElementById('analytics-roi').textContent = 
                    totalRevenue > 0 ? ((classified.reduce((a, b) => a + b.revenue, 0) - 
                    classified.reduce((a, b) => a + (Store.getRecipe(b.name) ? this.calculateRecipeCost(Store.getRecipe(b.name)) * b.quantity : 0), 0)) / 
                    totalRevenue * 100).toFixed(0) + '%' : '0%';
                
                document.getElementById('analytics-conversion').textContent = conversion.toFixed(1) + '%';
                
                const beUnits = Store.data.fixedCost > 0 && classified[0] ? 
                    Math.ceil(Store.data.fixedCost / (classified[0].price - this.calculateRecipeCost(Store.getRecipe(classified[0].name)))) : 0;
                document.getElementById('analytics-breakeven').textContent = beUnits > 0 ? beUnits : 0;
            }
        };

        // ==========================================
        // UI CONTROLLER (ORIGINAL PRESERVADO)
        // ==========================================

        const UI = {
            showModal(id) {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                el.classList.add('flex');
            },

            hideModal(id) {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.classList.remove('flex');
            },

            showToast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                const colors = {
                    success: 'bg-emerald-500',
                    error: 'bg-red-500',
                    warning: 'bg-amber-500',
                    info: 'bg-blue-500'
                };
                
                toast.className = `${colors[type]} text-white px-6 py-4 rounded-xl text-xs font-black uppercase shadow-2xl flex items-center gap-3 animate-slide-up pointer-events-auto`;
                toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i><span>${msg}</span>`;
                
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },

            setLoading(btnId, loading) {
                const btn = document.getElementById(btnId);
                const spinner = btn.querySelector('.fa-spin');
                const text = btn.querySelector('span');
                
                if (loading) {
                    btn.disabled = true;
                    if (spinner) spinner.classList.remove('hidden');
                    if (text) text.textContent = 'Processando...';
                } else {
                    btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (text) text.textContent = 'Confirmar e Baixar';
                }
            },

            updateDaysBadge() {
                const days = Store.getDaysRemaining();
                const badge = document.getElementById('days-left');
                
                badge.textContent = `${days} DIAS`;
                
                badge.classList.remove('warning', 'danger', 'bg-emerald-100', 'text-emerald-700');
                
                if (days <= 7) {
                    badge.classList.add('danger');
                } else if (days <= 30) {
                    badge.classList.add('warning');
                } else {
                    badge.classList.add('bg-emerald-100', 'text-emerald-700');
                }
            },

            showSaleStatus(msg, type = 'info') {
                const statusEl = document.getElementById('sale-status');
                statusEl.textContent = msg;
                statusEl.className = `mt-4 text-xs font-bold text-center ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-emerald-400' : 'text-blue-400'}`;
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
            }
        };

        // ==========================================
        // AUTH (ORIGINAL PRESERVADO)
        // ==========================================

        const Auth = {
            login() {
                const doc = document.getElementById('auth-doc').value.replace(/\D/g, '');
                const key = document.getElementById('license-key').value.trim();
                
                if (doc.length < 11 || key.length < 3) {
                    UI.showToast('Preencha todos os campos', 'error');
                    return;
                }

                if (Store.data.firstAccessDate && Store.isExpired()) {
                    UI.showToast('Licença expirada. Contate o suporte.', 'error');
                    return;
                }

                UI.setLoading('btn-login', true);
                
                setTimeout(() => {
                    Store.data.license = key;
                    Store.data.storeDoc = doc;
                    
                    if (!Store.data.firstAccessDate) {
                        Store.data.firstAccessDate = new Date().toISOString();
                    }
                    
                    Store.save();
                    
                    UI.setLoading('btn-login', false);
                    this.unlock();
                }, 1000);
            },

            register() {
                const doc = document.getElementById('reg-doc').value.replace(/\D/g, '');
                const key = document.getElementById('reg-key').value.trim();
                
                if (doc.length < 11 || key.length < 3) {
                    UI.showToast('Preencha todos os campos', 'error');
                    return;
                }

                UI.showToast('Cadastro realizado! Faça login.');
                UI.hideModal('register-modal');
            },

            unlock() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                
                document.getElementById('user-id').textContent = `ID: ${Store.data.storeDoc.slice(-4)}`;
                
                UI.updateDaysBadge();
                
                App.init();
            },

            logout() {
                if (confirm('Deseja sair?')) location.reload();
            }
        };

        // ==========================================
        // APP CONTROLLER (ORIGINAL PRESERVADO + BACKUP)
        // ==========================================

        const App = {
            currentTab: 'dash',
            charts: {},

            init() {
                this.setupTabs();
                this.setupInputs();
                Render.all();
                Charts.init();
                AI.generatePredictions();
                AI.compareRecipes();
                AI.generateABCAnalysis();
                Backup.init(); // Inicializa sistema de backup
                
                setInterval(() => {
                    AI.generatePredictions();
                    AI.analyzeRecipe();
                }, 30000);
                
                setInterval(() => UI.updateDaysBadge(), 60000);
            },

            setupTabs() {
                this.switchTab('dash');
            },

            switchTab(tab) {
                this.currentTab = tab;
                
                document.querySelectorAll('main > div[id^="section-"]').forEach(el => {
                    el.classList.add('hidden');
                });
                
                document.getElementById(`section-${tab}`).classList.remove('hidden');
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-[var(--text-secondary)]');
                });
                
                const activeBtn = document.getElementById(`tab-${tab}`);
                activeBtn.classList.add('tab-active');
                activeBtn.classList.remove('text-[var(--text-secondary)]');

                if (tab === 'dash') {
                    setTimeout(() => Charts.update(), 100);
                    AI.generatePredictions();
                } else if (tab === 'recipes') {
                    setTimeout(() => AI.analyzeRecipe(), 100);
                    AI.compareRecipes();
                } else if (tab === 'analytics') {
                    AI.generateABCAnalysis();
                    this.initAnalyticsCharts();
                }
            },

            setupInputs() {
                document.getElementById('auth-doc')?.addEventListener('input', (e) => {
                    let v = e.target.value.replace(/\D/g, '');
                    if (v.length <= 11) {
                        v = v.replace(/(\d{3})(\d)/, '$1.$2');
                        v = v.replace(/(\d{3})(\d)/, '$1.$2');
                        v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    } else {
                        v = v.replace(/^(\d{2})(\d)/, '$1.$2');
                        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                        v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
                        v = v.replace(/(\d{4})(\d)/, '$1-$2');
                    }
                    e.target.value = v;
                });
            },

            saveMeta() {
                const value = parseFloat(document.getElementById('input-meta').value);
                if (isNaN(value) || value <= 0) {
                    UI.showToast('Digite um valor válido', 'error');
                    return;
                }
                Store.setMeta(value);
                Render.dashboard();
                UI.showToast('Meta salva!');
            },

            closeDay() {
                if (!confirm('Confirma fechamento do dia?')) return;
                
                Store.closeDay();
                Render.all();
                AI.generatePredictions();
                UI.showToast('Dia fechado com sucesso!');
            },

            clearHistory() {
                if (!confirm('Limpar todo histórico?')) return;
                Store.clearHistory();
                Render.history();
                UI.showToast('Histórico limpo');
            },

            initAnalyticsCharts() {
                const ctxMargins = document.getElementById('chart-margins');
                if (ctxMargins) {
                    const recipes = Object.entries(Store.data.recipes);
                    new Chart(ctxMargins, {
                        type: 'line',
                        data: {
                            labels: recipes.map(([name, _]) => name),
                            datasets: [{
                                label: 'Margem %',
                                data: recipes.map(([_, r]) => {
                                    const cost = AI.calculateRecipeCost(r);
                                    return ((r.price - cost) / r.price * 100).toFixed(1);
                                }),
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                const ctxProj = document.getElementById('chart-projection');
                if (ctxProj) {
                    const history = Store.data.historyLog.slice(0, 7).reverse();
                    const trend = history.map((h, i) => h.profit);
                    
                    const projected = [...trend];
                    if (trend.length >= 2) {
                        const growth = (trend[trend.length - 1] - trend[0]) / trend.length;
                        for (let i = 0; i < 7; i++) {
                            projected.push(projected[projected.length - 1] + growth);
                        }
                    }

                    new Chart(ctxProj, {
                        type: 'line',
                        data: {
                            labels: [...Array(14).keys()].map(i => `D${i+1}`),
                            datasets: [{
                                label: 'Real',
                                data: [...trend, ...Array(7).fill(null)],
                                borderColor: '#3b82f6',
                                tension: 0.4
                            }, {
                                label: 'Projeção IA',
                                data: Array(trend.length).fill(null).concat(trend.length > 0 ? [trend[trend.length-1]] : []).concat(projected.slice(trend.length)),
                                borderColor: '#8b5cf6',
                                borderDash: [5, 5],
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            }
        };

        // ==========================================
        // RENDER ENGINE (ORIGINAL PRESERVADO)
        // ==========================================

        const Render = {
            all() {
                this.dashboard();
                this.inventory();
                this.recipes();
                this.history();
                this.selects();
                this.quickStats();
            },

            dashboard() {
                const totalCosts = Store.data.dailyUsage.reduce((sum, u) => sum + (u.cost || 0), 0);
                const profit = Store.data.dailySales - totalCosts;
                const monthly = Store.getMonthlyStats();

                document.getElementById('metric-sales').textContent = Store.formatMoney(Store.data.dailySales);
                document.getElementById('metric-costs').textContent = Store.formatMoney(totalCosts);
                document.getElementById('metric-profit').textContent = Store.formatMoney(profit);
                document.getElementById('metric-profit').className = `text-3xl font-black tabular-nums ${profit >= 0 ? 'text-emerald-600' : 'text-red-500'}`;

                const yesterday = Store.data.historyLog[0];
                if (yesterday) {
                    const trend = Store.data.dailySales - yesterday.sales;
                    const trendEl = document.getElementById('sales-trend');
                    const trendIcon = trend >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                    const trendColor = trend >= 0 ? 'text-emerald-600' : 'text-red-500';
                    const trendPct = yesterday.sales > 0 ? Math.abs((trend / yesterday.sales) * 100).toFixed(0) : 0;
                    
                    trendEl.className = `text-[10px] mt-2 font-bold ${trendColor} flex items-center gap-1`;
                    trendEl.innerHTML = `<i class="fas ${trendIcon}"></i> <span>${trend >= 0 ? '+' : '-'}${trendPct}%</span> vs ontem`;
                }

                const costMargin = Store.data.dailySales > 0 ? (totalCosts / Store.data.dailySales * 100).toFixed(1) : 0;
                document.getElementById('cost-margin').textContent = `Representa ${costMargin}% das vendas`;

                const hour = new Date().getHours();
                const operatingHours = Math.max(1, hour - 8);
                const profitPerHour = profit / operatingHours;
                document.getElementById('profit-per-hour').textContent = `${Store.formatMoney(profitPerHour)}/hora`;

                const beCard = document.getElementById('card-be');
                const beLabel = document.getElementById('label-be');
                const beValue = document.getElementById('metric-be');
                const beBadge = document.getElementById('badge-be');
                const beProgress = document.getElementById('progress-be');

                if (!Store.data.fixedCost || Store.data.fixedCost === 0) {
                    beLabel.textContent = 'Meta não definida';
                    beValue.textContent = 'R$ 0,00';
                    beBadge.textContent = 'Configure acima';
                    beBadge.className = 'inline-block mt-2 text-[10px] font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded-full';
                    beCard.className = 'glass-panel p-6 border-b-4 border-gray-400 metric-card';
                    beProgress.style.width = '0%';
                    beProgress.className = 'bg-gray-400 h-full transition-all duration-500';
                    return;
                }

                const target = Store.data.fixedCost;
                const current = Store.data.currentFixedLeft !== undefined ? Store.data.currentFixedLeft : target;
                const achieved = target - current;
                const percent = Math.min(100, Math.max(0, (achieved / target) * 100));

                if (current <= 0) {
                    beLabel.textContent = 'Lucro Líquido Real';
                    beValue.textContent = Store.formatMoney(Math.abs(current));
                    beValue.className = 'text-2xl font-black tabular-nums text-emerald-600';
                    beBadge.textContent = 'META ALCANÇADA 🚀';
                    beBadge.className = 'inline-block mt-2 text-[10px] font-bold bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full';
                    beCard.className = 'glass-panel p-6 border-b-4 border-emerald-500 metric-card';
                    beProgress.style.width = '100%';
                    beProgress.className = 'bg-emerald-500 h-full transition-all duration-500';
                } else {
                    beLabel.textContent = 'Pendente Break-Even';
                    beValue.textContent = Store.formatMoney(current);
                    beValue.className = 'text-2xl font-black tabular-nums text-amber-600';
                    beBadge.textContent = `${percent.toFixed(0)}% atingido`;
                    beBadge.className = 'inline-block mt-2 text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded-full';
                    beCard.className = 'glass-panel p-6 border-b-4 border-amber-500 metric-card';
                    beProgress.style.width = `${percent}%`;
                    beProgress.className = 'bg-amber-500 h-full transition-all duration-500';
                }

                document.getElementById('pdf-sales').textContent = Store.formatMoney(monthly.sales);
                document.getElementById('pdf-costs').textContent = Store.formatMoney(monthly.costs);
                document.getElementById('pdf-profit').textContent = Store.formatMoney(monthly.profit);

                const tbody = document.getElementById('table-usage');
                if (Store.data.dailyUsage.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-[var(--text-secondary)] text-sm">Nenhuma saída registrada hoje</td></tr>';
                } else {
                    tbody.innerHTML = Store.data.dailyUsage.map(u => `
                        <tr class="hover:bg-[var(--bg-tertiary)] transition-colors">
                            <td class="px-6 py-4 font-bold text-xs">${u.name}</td>
                            <td class="px-6 py-4 text-xs font-mono">${u.qty}${u.unit}</td>
                            <td class="px-6 py-4 text-right text-red-500 font-bold tabular-nums">${Store.formatMoney(u.cost)}</td>
                            <td class="px-6 py-4 text-center no-print">
                                <button onclick="Sales.deleteUsage(${u.id})" class="text-[var(--text-secondary)] hover:text-red-500 transition-colors p-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            },

            inventory() {
                const grid = document.getElementById('grid-inventory');
                const items = Object.entries(Store.data.inventory);
                
                if (items.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full glass-panel p-12 text-center text-[var(--text-secondary)]">
                            <i class="fas fa-box-open text-4xl mb-4 opacity-50"></i>
                            <p class="text-sm font-bold uppercase">Nenhum insumo cadastrado</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = items.map(([name, data]) => {
                    const isCritical = data.stock < 500;
                    const displayQty = data.stock >= 1000 ? 
                        `${(data.stock/1000).toFixed(2)}${data.unit === 'g' ? 'kg' : 'L'}` : 
                        `${Math.round(data.stock)}${data.unit}`;
                    
                    const dailyUsage = Store.data.dailyUsage
                        .filter(u => u.name === name)
                        .reduce((a, b) => a + b.qty, 0);
                    const daysLeft = dailyUsage > 0 ? Math.floor(data.stock / dailyUsage) : '∞';
                    
                    return `
                        <div class="glass-panel p-6 ${isCritical ? 'critical-stock' : 'border-t-4 border-electric-500'} relative group">
                            <div class="absolute top-4 right-4 flex gap-2 no-print opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="Inventory.openEdit('${name}')" class="text-electric-500 hover:text-electric-600 bg-electric-50 hover:bg-electric-100 p-2 rounded-lg transition-all" title="Renovar Estoque">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button onclick="Inventory.delete('${name}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-all" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <h4 class="font-black text-[10px] uppercase text-[var(--text-secondary)] mb-2 tracking-widest">${name}</h4>
                            <p class="text-3xl font-black tabular-nums">
                                ${displayQty}
                            </p>
                            <p class="text-[10px] font-bold text-emerald-600 mt-2">
                                ${Store.formatMoney(data.fullUnitPrice)}/${data.originalUnit}
                            </p>
                            ${isCritical ? '<span class="inline-block mt-2 text-[9px] font-black text-red-600 bg-red-100 px-2 py-1 rounded-full animate-pulse">ESTOQUE CRÍTICO</span>' : 
                              `<span class="inline-block mt-2 text-[9px] font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">~${daysLeft} dias restantes</span>`}
                            
                            <div class="mt-3 pt-3 border-t border-[var(--border-subtle)] text-[10px] text-[var(--text-secondary)] no-print">
                                <i class="fas fa-info-circle mr-1"></i>
                                Clique no lápis para renovar
                            </div>
                        </div>
                    `;
                }).join('');
            },

            recipes() {
                const grid = document.getElementById('grid-recipes');
                const recipes = Object.entries(Store.data.recipes);
                
                if (recipes.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full glass-panel p-12 text-center text-[var(--text-secondary)]">
                            <i class="fas fa-utensils text-4xl mb-4 opacity-50"></i>
                            <p class="text-sm font-bold uppercase">Nenhuma receita cadastrada</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = recipes.map(([name, rec]) => {
                    const cost = AI.calculateRecipeCost(rec);
                    const margin = ((rec.price - cost) / rec.price * 100).toFixed(1);
                    const perf = Store.data.productPerformance[name] || { quantity: 0, revenue: 0 };
                    
                    return `
                        <div class="glass-panel p-6 border-t-4 ${margin >= 60 ? 'border-emerald-500' : margin >= 40 ? 'border-amber-500' : 'border-red-500'}">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="font-black text-xs uppercase">${name}</h4>
                                    <p class="text-[10px] text-[var(--text-secondary)] mt-1">${rec.ingredients.length} insumos</p>
                                </div>
                                <div class="flex gap-2">
                                    <span class="text-[10px] font-black ${margin >= 60 ? 'bg-emerald-100 text-emerald-700' : margin >= 40 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'} px-2 py-1 rounded-full">
                                        ${margin}% margem
                                    </span>
                                    <button onclick="Recipes.loadForEdit('${name}')" class="text-electric-500 hover:text-electric-600 p-1">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div>
                                    <p class="text-[9px] text-[var(--text-secondary)] uppercase">Custo</p>
                                    <p class="text-sm font-black text-red-500">${Store.formatMoney(cost)}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] text-[var(--text-secondary)] uppercase">Venda</p>
                                    <p class="text-sm font-black text-emerald-600">${Store.formatMoney(rec.price)}</p>
                                </div>
                            </div>
                            ${perf.quantity > 0 ? `
                                <div class="pt-3 border-t border-[var(--border-subtle)] text-[10px]">
                                    <div class="flex justify-between mb-1">
                                        <span class="text-[var(--text-secondary)]">Vendidos:</span>
                                        <span class="font-bold">${perf.quantity} un</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-[var(--text-secondary)]">Faturamento:</span>
                                        <span class="font-bold text-emerald-600">${Store.formatMoney(perf.revenue)}</span>
                                    </div>
                                </div>
                            ` : '<div class="pt-3 border-t border-[var(--border-subtle)] text-[10px] text-[var(--text-secondary)] italic">Sem vendas registradas</div>'}
                        </div>
                    `;
                }).join('');
            },

            history() {
                const tbody = document.getElementById('table-history');
                
                if (Store.data.historyLog.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-[var(--text-secondary)] text-sm">Nenhum fechamento registrado</td></tr>';
                    return;
                }

                tbody.innerHTML = Store.data.historyLog.map(h => `
                    <tr class="hover:bg-[var(--bg-tertiary)] transition-colors">
                        <td class="py-3 text-[var(--text-secondary)] text-xs">${h.date}</td>
                        <td class="py-3 text-right font-bold tabular-nums">${Store.formatMoney(h.sales)}</td>
                        <td class="py-3 text-right text-red-400 font-bold tabular-nums">${Store.formatMoney(h.costs)}</td>
                        <td class="py-3 text-right ${h.profit >= 0 ? 'text-emerald-600' : 'text-red-500'} font-black tabular-nums">
                            ${Store.formatMoney(h.profit)}
                        </td>
                    </tr>
                `).join('');
            },

            selects() {
                const options = Object.keys(Store.data.inventory)
                    .sort()
                    .map(n => `<option value="${n}">${n}</option>`)
                    .join('');

                ['select-insumo', 'select-ing'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        const current = el.value;
                        el.innerHTML = `<option value="">Selecionar...</option>${options}`;
                        el.value = current;
                    }
                });

                const prodSelect = document.getElementById('select-product');
                if (prodSelect) {
                    const current = prodSelect.value;
                    const prodOptions = Object.keys(Store.data.recipes)
                        .sort()
                        .map(n => `<option value="${n}">${n}</option>`)
                        .join('');
                    prodSelect.innerHTML = `<option value="">Selecionar Produto...</option>${prodOptions}`;
                    prodSelect.value = current;
                }
            },

            quickStats() {
                const monthly = Store.getMonthlyStats();
                const avgTicket = monthly.sales > 0 && Store.data.historyLog.length > 0 ? 
                    monthly.sales / Store.data.historyLog.reduce((a, h) => a + 1, 0) : 0;
                
                document.getElementById('quick-avg-ticket').textContent = Store.formatMoney(avgTicket);
                document.getElementById('quick-active-products').textContent = Object.keys(Store.data.recipes).length;
                
                const recipes = Object.entries(Store.data.recipes);
                const avgMargin = recipes.length > 0 ? 
                    recipes.reduce((a, [_, r]) => {
                        const cost = AI.calculateRecipeCost(r);
                        return a + ((r.price - cost) / r.price * 100);
                    }, 0) / recipes.length : 0;
                
                document.getElementById('quick-avg-margin').textContent = avgMargin.toFixed(1) + '%';
            }
        };

        // ==========================================
        // CHARTS (ORIGINAL PRESERVADO)
        // ==========================================

        const Charts = {
            init() {
                this.initMain();
                this.initPizza();
            },

            initMain() {
                const ctx = document.getElementById('chart-main')?.getContext('2d');
                if (!ctx) return;

                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                App.charts.main = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Lucro',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => Store.formatMoney(ctx.parsed.y)
                                }
                            }
                        },
                        scales: {
                            x: { grid: { display: false } },
                            y: {
                                border: { display: false },
                                grid: { color: '#f1f5f9' },
                                ticks: {
                                    callback: (v) => `R$ ${v/1000}k`
                                }
                            }
                        }
                    }
                });
            },

            initPizza() {
                const ctx = document.getElementById('chart-pizza')?.getContext('2d');
                if (!ctx) return;

                App.charts.pizza = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Vendas', 'Custos'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['#3b82f6', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            },

            update() {
                if (!App.charts.main || !App.charts.pizza) return;

                const recent = [...Store.data.historyLog].slice(0, 7).reverse();
                App.charts.main.data.labels = recent.map(h => h.date);
                App.charts.main.data.datasets[0].data = recent.map(h => h.profit);
                App.charts.main.update();

                const monthly = Store.getMonthlyStats();
                App.charts.pizza.data.datasets[0].data = [monthly.sales, monthly.costs];
                App.charts.pizza.update();
            }
        };

        // ==========================================
        // INVENTORY MODULE (ORIGINAL PRESERVADO)
        // ==========================================

        const Inventory = {
            editingItem: null,

            add() {
                const name = document.getElementById('inv-name').value.trim().toUpperCase();
                const qty = parseFloat(document.getElementById('inv-qty').value);
                const unit = document.getElementById('inv-unit').value;
                const price = parseFloat(document.getElementById('inv-price').value);

                if (!name || isNaN(qty) || isNaN(price) || qty <= 0 || price <= 0) {
                    UI.showToast('Preencha todos os campos corretamente', 'error');
                    return;
                }

                let baseQty = (unit === 'kg' || unit === 'L') ? qty * 1000 : qty;
                let baseUnit = unit === 'kg' ? 'g' : unit === 'L' ? 'ml' : 'un';

                const existing = Store.getInventory(name);
                if (existing) {
                    const totalQty = existing.stock + baseQty;
                    const totalPrice = (existing.stock * existing.pricePerBase) + price;
                    
                    Store.setInventory(name, {
                        stock: totalQty,
                        pricePerBase: totalPrice / totalQty,
                        fullUnitPrice: totalPrice / (totalQty / (unit === 'kg' || unit === 'L' ? 1000 : 1)),
                        unit: baseUnit,
                        originalUnit: unit
                    });
                } else {
                    Store.setInventory(name, {
                        stock: baseQty,
                        pricePerBase: price / baseQty,
                        fullUnitPrice: price / qty,
                        unit: baseUnit,
                        originalUnit: unit
                    });
                }

                document.getElementById('inv-name').value = '';
                document.getElementById('inv-qty').value = '';
                document.getElementById('inv-price').value = '';

                Render.inventory();
                Render.selects();
                UI.showToast('Insumo cadastrado!');
            },

            openEdit(name) {
                const item = Store.getInventory(name);
                if (!item) return;

                this.editingItem = name;
                
                document.getElementById('edit-item-name').textContent = name;
                document.getElementById('edit-current-stock').textContent = 
                    `${Math.round(item.stock)} ${item.unit}`;
                
                const unitSelect = document.getElementById('edit-unit');
                unitSelect.value = item.originalUnit || 'kg';
                
                document.getElementById('edit-add-qty').value = '';
                document.getElementById('edit-add-price').value = '';

                UI.showModal('edit-inventory-modal');
            },

            saveEdit() {
                if (!this.editingItem) return;

                const qty = parseFloat(document.getElementById('edit-add-qty').value);
                const unit = document.getElementById('edit-unit').value;
                const price = parseFloat(document.getElementById('edit-add-price').value);

                if (isNaN(qty) || isNaN(price) || qty <= 0 || price <= 0) {
                    UI.showToast('Preencha quantidade e preço', 'error');
                    return;
                }

                const item = Store.getInventory(this.editingItem);
                
                let baseQty = (unit === 'kg' || unit === 'L') ? qty * 1000 : qty;
                
                const currentTotalValue = item.stock * item.pricePerBase;
                const newValue = price;
                const newTotalQty = item.stock + baseQty;
                
                const newPricePerBase = (currentTotalValue + newValue) / newTotalQty;
                
                Store.setInventory(this.editingItem, {
                    stock: newTotalQty,
                    pricePerBase: newPricePerBase,
                    fullUnitPrice: newPricePerBase * (unit === 'kg' || unit === 'L' ? 1000 : 1),
                    unit: item.unit,
                    originalUnit: item.originalUnit
                });

                UI.hideModal('edit-inventory-modal');
                Render.inventory();
                UI.showToast(`Estoque de ${this.editingItem} renovado!`);
                
                this.editingItem = null;
            },

            delete(name) {
                if (!confirm(`Excluir ${name}?`)) return;
                Store.deleteInventory(name);
                Render.inventory();
                Render.selects();
                UI.showToast('Insumo removido');
            }
        };

        // ==========================================
        // RECIPES MODULE (ORIGINAL PRESERVADO)
        // ==========================================

        const Recipes = {
            tempIngredients: [],

            addIng() {
                const name = document.getElementById('select-ing').value;
                const qty = parseFloat(document.getElementById('ing-qty').value);
                const unit = document.getElementById('ing-unit').value;

                if (!name || isNaN(qty) || qty <= 0) {
                    UI.showToast('Selecione insumo e quantidade', 'error');
                    return;
                }

                this.tempIngredients.push({ id: Date.now(), name, qty, unit });
                this.renderTemp();
                AI.analyzeRecipe();
                
                document.getElementById('ing-qty').value = '';
            },

            removeIng(id) {
                this.tempIngredients = this.tempIngredients.filter(i => i.id !== id);
                this.renderTemp();
                AI.analyzeRecipe();
            },

            renderTemp() {
                const container = document.getElementById('list-temp-ing');
                container.innerHTML = this.tempIngredients.map(i => `
                    <span class="inline-flex items-center gap-2 bg-electric-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold">
                        ${i.name} ${i.qty}${i.unit}
                        <button onclick="Recipes.removeIng(${i.id})" class="hover:bg-white/20 rounded p-0.5">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `).join('');
            },

            save() {
                const name = document.getElementById('rec-name').value.trim().toUpperCase();
                const price = parseFloat(document.getElementById('rec-price').value);

                if (!name || isNaN(price) || price <= 0) {
                    UI.showToast('Preencha nome e preço', 'error');
                    return;
                }

                if (this.tempIngredients.length === 0) {
                    UI.showToast('Adicione pelo menos um insumo', 'error');
                    return;
                }

                const cost = AI.calculateRecipeCost({ ingredients: this.tempIngredients });
                if (price <= cost) {
                    if (!confirm('ATENÇÃO: Preço está abaixo do custo! Deseja salvar assim mesmo?')) {
                        return;
                    }
                }

                Store.setRecipe(name, {
                    price,
                    ingredients: [...this.tempIngredients]
                });

                this.tempIngredients = [];
                document.getElementById('rec-name').value = '';
                document.getElementById('rec-price').value = '';
                this.renderTemp();

                Render.recipes();
                Render.selects();
                UI.showToast('Receita salva!');
                
                document.getElementById('ai-cost-total').textContent = 'R$ 0,00';
                document.getElementById('ai-suggested-price').textContent = 'R$ 0,00';
                document.getElementById('ai-current-margin').textContent = '0%';
                document.getElementById('ai-margin-bar').style.width = '0%';
                document.getElementById('ai-ingredient-analysis').innerHTML = '<p class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2">Análise por Insumo</p><div class="text-sm text-[var(--text-secondary)] italic">Adicione ingredientes para ver a análise detalhada...</div>';
                document.getElementById('ai-suggestions').classList.add('hidden');
            },

            loadForEdit(name) {
                const rec = Store.getRecipe(name);
                if (!rec) return;

                document.getElementById('rec-name').value = name;
                document.getElementById('rec-price').value = rec.price;
                this.tempIngredients = [...rec.ingredients];
                this.renderTemp();
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                UI.showToast(`Editando: ${name}`, 'warning');
                
                setTimeout(() => AI.analyzeRecipe(), 100);
            }
        };

        // ==========================================
        // SALES MODULE (ORIGINAL PRESERVADO)
        // ==========================================

        const Sales = {
            sellProduct() {
                console.log('Iniciando venda automática...');
                
                const productSelect = document.getElementById('select-product');
                const qtyInput = document.getElementById('sale-qty');
                
                if (!productSelect || !qtyInput) {
                    console.error('Elementos não encontrados!');
                    UI.showToast('Erro interno. Recarregue a página.', 'error');
                    return;
                }

                const productName = productSelect.value;
                const qty = parseFloat(qtyInput.value);

                console.log('Produto:', productName, 'Qtd:', qty);

                if (!productName || productName === '') {
                    UI.showToast('Selecione um produto', 'error');
                    productSelect.focus();
                    return;
                }

                if (isNaN(qty) || qty <= 0) {
                    UI.showToast('Digite uma quantidade válida', 'error');
                    qtyInput.focus();
                    return;
                }

                const recipe = Store.getRecipe(productName);
                if (!recipe) {
                    UI.showToast('Receita não encontrada', 'error');
                    return;
                }

                console.log('Receita encontrada:', recipe);

                if (!recipe.ingredients || recipe.ingredients.length === 0) {
                    UI.showToast('Receita sem insumos cadastrados', 'error');
                    return;
                }

                let hasError = false;
                const usagePlan = [];

                for (const ing of recipe.ingredients) {
                    const item = Store.getInventory(ing.name);
                    
                    if (!item) {
                        UI.showToast(`Insumo "${ing.name}" não existe no estoque`, 'error');
                        hasError = true;
                        break;
                    }

                    let neededQty;
                    if (ing.unit === 'g' || ing.unit === 'ml') {
                        neededQty = ing.qty * qty;
                    } else {
                        neededQty = ing.qty * qty;
                    }

                    console.log(`Insumo ${ing.name}: precisa ${neededQty}${item.unit}, tem ${item.stock}${item.unit}`);

                    if (neededQty > item.stock) {
                        UI.showToast(`Estoque insuficiente: ${ing.name} (precisa: ${neededQty}${item.unit}, tem: ${Math.round(item.stock)}${item.unit})`, 'error');
                        hasError = true;
                        break;
                    }

                    usagePlan.push({
                        name: ing.name,
                        neededQty: neededQty,
                        item: item,
                        unitCost: item.pricePerBase
                    });
                }

                if (hasError) return;

                console.log('Plano de consumo:', usagePlan);

                let totalCost = 0;
                
                for (const plan of usagePlan) {
                    plan.item.stock -= plan.neededQty;
                    const cost = plan.neededQty * plan.unitCost;
                    totalCost += cost;

                    Store.setInventory(plan.name, plan.item);

                    Store.addUsage({
                        name: plan.name,
                        qty: plan.neededQty,
                        unit: plan.item.unit,
                        cost: cost,
                        product: productName,
                        type: 'auto'
                    });

                    console.log(`Consumido: ${plan.name} - ${plan.neededQty}${plan.item.unit} = ${Store.formatMoney(cost)}`);
                }

                const revenue = recipe.price * qty;
                Store.addSale(revenue, productName);

                console.log('Venda total:', Store.formatMoney(revenue), 'Custo:', Store.formatMoney(totalCost));

                qtyInput.value = '';
                productSelect.value = '';

                Render.dashboard();
                Render.inventory();
                Render.recipes();
                
                const profit = revenue - totalCost;
                UI.showToast(`✅ Venda: ${Store.formatMoney(revenue)} | Lucro: ${Store.formatMoney(profit)}`);
                
                AI.generatePredictions();
            },

            addManualUsage() {
                const name = document.getElementById('select-insumo').value;
                const qty = parseFloat(document.getElementById('usage-qty-input').value);
                const unit = document.getElementById('usage-unit-input').value;

                if (!name || isNaN(qty) || qty <= 0) {
                    UI.showToast('Selecione insumo e quantidade', 'error');
                    return;
                }

                const item = Store.getInventory(name);
                if (!item) {
                    UI.showToast('Insumo não encontrado', 'error');
                    return;
                }

                let baseQty = (unit === 'kg' || unit === 'L') ? qty * 1000 : qty;
                
                if (baseQty > item.stock) {
                    UI.showToast(`Estoque insuficiente. Disponível: ${item.stock}${item.unit}`, 'error');
                    return;
                }

                item.stock -= baseQty;
                Store.setInventory(name, item);

                const cost = baseQty * item.pricePerBase;
                Store.addUsage({
                    name,
                    qty: baseQty,
                    unit: item.unit,
                    cost,
                    type: 'manual'
                });

                document.getElementById('usage-qty-input').value = '';
                
                Render.dashboard();
                Render.inventory();
                UI.showToast('Uso registrado');
            },

            addManualSale() {
                const value = parseFloat(document.getElementById('manual-sale').value);
                
                if (isNaN(value) || value <= 0) {
                    UI.showToast('Digite um valor válido', 'error');
                    return;
                }

                Store.addSale(value);
                document.getElementById('manual-sale').value = '';
                
                Render.dashboard();
                UI.showToast(`Venda adicionada: ${Store.formatMoney(value)}`);
            },

            deleteUsage(id) {
                const usage = Store.data.dailyUsage.find(u => u.id === id);
                if (!usage) return;

                const item = Store.getInventory(usage.name);
                if (item) {
                    item.stock += usage.qty;
                    Store.setInventory(usage.name, item);
                }

                if (usage.type === 'auto' && usage.product) {
                    const recipe = Store.getRecipe(usage.product);
                    if (recipe) {
                        const ingInRecipe = recipe.ingredients.find(i => i.name === usage.name);
                        if (ingInRecipe) {
                            const unitsSold = Math.round(usage.qty / ingInRecipe.qty);
                            Store.data.dailySales -= (recipe.price * unitsSold);
                            
                            if (Store.data.productPerformance[usage.product]) {
                                Store.data.productPerformance[usage.product].sales -= unitsSold;
                                Store.data.productPerformance[usage.product].revenue -= (recipe.price * unitsSold);
                            }
                        }
                    }
                }

                Store.removeUsage(id);
                
                Render.dashboard();
                Render.inventory();
                Render.recipes();
                UI.showToast('Operação cancelada');
            }
        };

        // ==========================================
        // REPORTS (ORIGINAL PRESERVADO)
        // ==========================================

        const Reports = {
            generatePDF() {
                document.getElementById('pdf-date').textContent = new Date().toLocaleString('pt-BR');
                document.getElementById('pdf-summary').classList.remove('hidden');
                window.print();
                setTimeout(() => {
                    document.getElementById('pdf-summary').classList.add('hidden');
                }, 100);
            },

            sendWhatsApp() {
                const totalCost = Store.data.dailyUsage.reduce((a, b) => a + (b.cost || 0), 0);
                const profit = Store.data.dailySales - totalCost;
                const status = Store.data.currentFixedLeft <= 0 ? 
                    `✅ Lucro Líquido: ${Store.formatMoney(Math.abs(Store.data.currentFixedLeft))}` :
                    `⏳ Break-Even: ${Store.formatMoney(Store.data.currentFixedLeft)}`;

                const msg = `🚀 *GESTÃO PRO AI - RELATÓRIO*%0A%0A` +
                           `💰 Vendas: ${Store.formatMoney(Store.data.dailySales)}%0A` +
                           `📉 Custos: ${Store.formatMoney(totalCost)}%0A` +
                           `📊 Lucro: ${Store.formatMoney(profit)}%0A%0A` +
                           `${status}%0A%0A` +
                           `_Análise gerada por IA_ 🤖`;

                window.open(`https://wa.me/?text=${msg}`);
            }
        };

        // ==========================================
        // INIT
        // ==========================================

        Store.init();
        
        window.UI = UI;
        window.Auth = Auth;
        window.App = App;
        window.Inventory = Inventory;
        window.Recipes = Recipes;
        window.Sales = Sales;
        window.Reports = Reports;
        window.AI = AI;
        window.Backup = Backup;
        window.Store = Store;
    </script>
</body>
</html>
