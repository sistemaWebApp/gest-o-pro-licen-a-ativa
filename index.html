
<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Pro Enterprise - v7.3 Fix Venda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        navy: { 950: '#0f172a', 900: '#1e293b', 800: '#334155' },
                        electric: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-subtle: #e2e8f0;
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-subtle: #334155;
        }

        body { background-color: var(--bg-secondary); color: var(--text-primary); }
        
        .glass-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
        }

        .glass-panel:hover { transform: translateY(-2px); }
        
        .tab-active { 
            color: #3b82f6 !important; 
            position: relative;
        }
        
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3b82f6;
            border-radius: 3px 3px 0 0;
        }

        .critical-stock { 
            border-left: 4px solid #ef4444; 
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .tabular-nums { font-variant-numeric: tabular-nums; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
        }
        .print-only { display: none; }

        .days-badge { transition: all 0.3s ease; }
        .days-badge.warning { background: #fef3c7; color: #d97706; }
        .days-badge.danger { background: #fee2e2; color: #dc2626; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[9999] bg-navy-950 flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 animate-slide-up">
            <div class="w-20 h-20 bg-gradient-to-br from-electric-500 to-electric-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-8">
                <i class="fas fa-rocket text-white text-3xl"></i>
            </div>
            <h2 class="text-3xl font-black text-center mb-2">Ativação Enterprise</h2>
            <p class="text-sm text-center text-[var(--text-secondary)] mb-8">Licença de 365 dias a partir do primeiro acesso</p>
            
            <div class="space-y-4">
                <input type="text" id="auth-doc" maxlength="18" 
                    class="w-full p-5 bg-[var(--bg-tertiary)] rounded-2xl text-center text-lg font-bold uppercase tracking-wider border-2 border-transparent focus:border-electric-500 outline-none transition-all"
                    placeholder="CPF ou CNPJ">
                <input type="password" id="license-key" 
                    class="w-full p-5 bg-[var(--bg-tertiary)] rounded-2xl text-center text-xl font-bold uppercase tracking-[0.2em] border-2 border-transparent focus:border-electric-500 outline-none transition-all"
                    placeholder="CHAVE DE ACESSO">
            </div>

            <button onclick="Auth.login()" id="btn-login" 
                class="w-full mt-8 bg-electric-600 hover:bg-electric-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase text-xs tracking-[0.2em]">
                <span id="login-text">Ativar Sistema</span>
                <i id="login-spinner" class="fas fa-circle-notch fa-spin hidden ml-2"></i>
            </button>

            <button onclick="UI.showModal('register-modal')" 
                class="w-full mt-4 text-electric-600 font-bold text-[11px] uppercase tracking-widest">
                Primeiro Acesso? Criar Senha
            </button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="fixed inset-0 z-[10000] bg-navy-950/90 hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 animate-slide-up">
            <h3 class="text-2xl font-black mb-6 text-center">Criar Meu Acesso</h3>
            <div class="space-y-4">
                <input type="text" id="reg-doc" class="w-full p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="CPF/CNPJ">
                <input type="password" id="reg-key" class="w-full p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="Crie sua Senha">
                <button onclick="Auth.register()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-xl uppercase text-xs">Cadastrar</button>
                <button onclick="UI.hideModal('register-modal')" class="w-full text-[var(--text-secondary)] font-bold text-[11px] uppercase mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div id="edit-inventory-modal" class="fixed inset-0 z-[10000] bg-navy-950/90 hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg p-8 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Renovar Estoque</h3>
                <button onclick="UI.hideModal('edit-inventory-modal')" class="text-[var(--text-secondary)] hover:text-red-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    Editando: <strong id="edit-item-name" class="uppercase"></strong>
                </p>
                <p class="text-xs text-blue-600 mt-1">Estoque atual: <span id="edit-current-stock" class="font-bold"></span></p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2 block">Quantidade a Adicionar</label>
                    <div class="flex gap-2">
                        <input type="number" id="edit-add-qty" class="flex-1 p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="Ex: 10">
                        <select id="edit-unit" class="p-4 bg-[var(--bg-tertiary)] rounded-xl text-sm font-black uppercase min-w-[100px] border-2 border-transparent focus:border-electric-500 outline-none">
                            <option value="kg">KG</option>
                            <option value="L">L</option>
                            <option value="un">UN</option>
                            <option value="g">g</option>
                            <option value="ml">ml</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase text-[var(--text-secondary)] mb-2 block">Preço Total Pago (novo lote)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-sm font-bold text-[var(--text-secondary)]">R$</span>
                        <input type="number" id="edit-add-price" class="w-full p-4 pl-10 bg-[var(--bg-tertiary)] rounded-xl font-bold border-2 border-transparent focus:border-electric-500 outline-none" placeholder="Valor pago no novo lote">
                    </div>
                    <p class="text-[10px] text-[var(--text-secondary)] mt-1">*O sistema calculará o preço médio ponderado automaticamente</p>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="Inventory.saveEdit()" class="flex-1 bg-electric-600 hover:bg-electric-500 text-white font-black py-4 rounded-xl uppercase text-xs tracking-widest transition-all">
                        <i class="fas fa-save mr-2"></i>Salvar Renovação
                    </button>
                    <button onclick="UI.hideModal('edit-inventory-modal')" class="px-6 bg-[var(--bg-tertiary)] text-[var(--text-secondary)] font-black py-4 rounded-xl uppercase text-xs hover:bg-gray-200 transition-all">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-content" class="hidden">
        <!-- Navigation -->
        <nav class="glass-panel sticky top-0 z-40 rounded-none border-x-0 border-t-0 no-print">
            <div class="max-w-7xl mx-auto px-6 flex justify-between items-center h-20">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-electric-500 to-electric-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-rocket text-white text-xl"></i>
                    </div>
                    <div>
                        <span class="font-black text-2xl italic">GESTÃO<span class="text-electric-500">PRO</span></span>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="user-id" class="text-[10px] font-bold text-[var(--text-secondary)]">ID: ----</span>
                            <span id="days-left" class="days-badge bg-emerald-100 text-emerald-700 text-[9px] px-2 py-0.5 rounded-full font-black">365 DIAS</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="flex gap-6 mr-6 border-b border-[var(--border-subtle)]">
                        <button onclick="App.switchTab('dash')" id="tab-dash" class="tab-btn px-2 py-6 text-[11px] font-black uppercase transition-colors tab-active">Dashboard</button>
                        <button onclick="App.switchTab('inventory')" id="tab-inventory" class="tab-btn px-2 py-6 text-[11px] font-black uppercase text-[var(--text-secondary)] transition-colors">Estoque</button>
                        <button onclick="App.switchTab('recipes')" id="tab-recipes" class="tab-btn px-2 py-6 text-[11px] font-black uppercase text-[var(--text-secondary)] transition-colors">Ficha Técnica</button>
                    </div>

                    <button onclick="Reports.generatePDF()" class="flex items-center gap-2 bg-navy-900 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase no-print">
                        <i class="fas fa-file-pdf"></i>PDF
                    </button>
                    <button onclick="Reports.sendWhatsApp()" class="flex items-center gap-2 bg-emerald-100 text-emerald-700 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase border border-emerald-200 no-print">
                        <i class="fab fa-whatsapp"></i>WhatsApp
                    </button>
                    <button onclick="App.closeDay()" class="bg-red-600 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase no-print">Fechar Dia</button>
                    <button onclick="Auth.logout()" class="text-[var(--text-secondary)] hover:text-red-500 no-print"><i class="fas fa-power-off text-lg"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6 space-y-8 pb-32">
            
            <!-- PDF Header -->
            <div id="pdf-header" class="print-only text-center border-b-4 border-electric-500 pb-6 mb-8">
                <h1 class="text-3xl font-black italic">GESTÃO PRO <span class="text-electric-500">ENTERPRISE</span></h1>
                <p class="text-xs font-bold text-[var(--text-secondary)] uppercase mt-2">Relatório Executivo</p>
                <p id="pdf-date" class="text-sm font-black mt-4"></p>
            </div>

            <!-- DASHBOARD SECTION -->
            <div id="section-dash" class="space-y-8 animate-fade-in">
                
                <!-- Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="metrics-container">
                    <div class="glass-panel p-6 border-b-4 border-electric-500">
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Vendas Hoje</p>
                        <h3 id="metric-sales" class="text-3xl font-black tabular-nums text-[var(--text-primary)]">R$ 0,00</h3>
                    </div>
                    
                    <div class="glass-panel p-6 border-b-4 border-red-500">
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Custo Materiais</p>
                        <h3 id="metric-costs" class="text-3xl font-black tabular-nums text-red-500">R$ 0,00</h3>
                    </div>
                    
                    <div class="glass-panel p-6 border-b-4 border-emerald-500">
                        <p class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Lucro Bruto Hoje</p>
                        <h3 id="metric-profit" class="text-3xl font-black tabular-nums text-emerald-600">R$ 0,00</h3>
                    </div>
                    
                    <div id="card-be" class="glass-panel p-6 border-b-4 border-amber-500">
                        <p id="label-be" class="text-[10px] font-black uppercase text-[var(--text-secondary)] tracking-widest mb-2">Pendente Break-Even</p>
                        <h3 id="metric-be" class="text-2xl font-black tabular-nums">R$ 0,00</h3>
                        <span id="badge-be" class="inline-block mt-2 text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded-full">Faltam 100%</span>
                        <div class="w-full bg-[var(--bg-tertiary)] h-2 mt-3 rounded-full overflow-hidden no-print">
                            <div id="progress-be" class="bg-amber-500 h-full w-0 transition-all duration-500"></div>
                        </div>
                    </div>
                </div>

                <!-- PDF Monthly Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 hidden print:grid" id="pdf-summary">
                    <div class="glass-panel p-6 bg-[var(--bg-tertiary)]">
                        <p class="text-[9px] font-black uppercase text-[var(--text-secondary)]">Vendas (30d)</p>
                        <h4 id="pdf-sales" class="text-xl font-black tabular-nums mt-2">R$ 0,00</h4>
                    </div>
                    <div class="glass-panel p-6 bg-[var(--bg-tertiary)]">
                        <p class="text-[9px] font-black uppercase text-[var(--text-secondary)]">Custos (30d)</p>
                        <h4 id="pdf-costs" class="text-xl font-black tabular-nums mt-2">R$ 0,00</h4>
                    </div>
                    <div class="glass-panel p-6 bg-[var(--bg-tertiary)]">
                        <p class="text-[9px] font-black uppercase text-[var(--text-secondary)]">Lucro (30d)</p>
                        <h4 id="pdf-profit" class="text-xl font-black tabular-nums mt-2">R$ 0,00</h4>
                    </div>
                </div>

                <!-- Quick Sale - CORRIGIDO -->
                <div class="glass-panel p-8 bg-gradient-to-br from-navy-900 to-navy-800 text-white no-print">
                    <h4 class="font-black text-xs uppercase mb-6 text-electric-400 tracking-widest flex items-center gap-2">
                        <i class="fas fa-bolt"></i> Venda Automática (Ficha Técnica)
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="relative">
                            <label class="text-[10px] text-navy-400 uppercase font-bold mb-1 block">Produto</label>
                            <select id="select-product" class="w-full bg-navy-800 border border-navy-700 p-4 rounded-xl text-sm font-bold text-white outline-none focus:border-electric-500 transition-colors">
                                <option value="">Selecionar Produto...</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label class="text-[10px] text-navy-400 uppercase font-bold mb-1 block">Quantidade</label>
                            <input type="number" id="sale-qty" min="1" step="1" class="w-full bg-navy-800 border border-navy-700 p-4 rounded-xl text-sm font-bold text-white outline-none focus:border-electric-500 transition-colors placeholder-navy-500" placeholder="Ex: 5">
                        </div>
                        <div class="flex items-end">
                            <button onclick="Sales.sellProduct()" id="btn-sell-product" class="w-full bg-electric-600 hover:bg-electric-500 disabled:opacity-50 disabled:cursor-not-allowed py-4 rounded-xl font-black uppercase text-xs tracking-widest transition-all shadow-lg flex items-center justify-center gap-2">
                                <span>Confirmar e Baixar</span>
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Debug/Status area -->
                    <div id="sale-status" class="mt-4 text-xs font-bold text-center hidden"></div>
                </div>

                <!-- Usage Table -->
                <div class="glass-panel overflow-hidden">
                    <div class="p-6 border-b border-[var(--border-subtle)] flex flex-wrap gap-4 justify-between items-center bg-[var(--bg-primary)]">
                        <h4 class="font-black text-xs uppercase tracking-widest text-electric-500">
                            <i class="fas fa-list-ul mr-2"></i>Detalhamento de Insumos (Saídas)
                        </h4>
                        <div class="flex gap-3 items-center no-print">
                            <select id="select-insumo" class="bg-[var(--bg-tertiary)] p-3.5 rounded-xl text-xs font-bold min-w-[180px] border border-[var(--border-subtle)] outline-none focus:border-electric-500">
                                <option value="">Selecionar Insumo...</option>
                            </select>
                            <input type="number" id="usage-qty-input" class="bg-[var(--bg-tertiary)] p-3.5 w-24 rounded-xl text-xs font-bold border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Qtd.">
                            <select id="usage-unit-input" class="bg-[var(--bg-tertiary)] p-3.5 rounded-xl text-[10px] font-black uppercase border border-[var(--border-subtle)] outline-none">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="ml">ml</option>
                                <option value="L">L</option>
                                <option value="un">un</option>
                            </select>
                            <button onclick="Sales.addManualUsage()" class="bg-electric-600 text-white w-12 h-12 rounded-xl shadow-lg flex items-center justify-center hover:bg-electric-500 transition-all">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-[var(--bg-tertiary)] text-[var(--text-secondary)] font-black text-[10px] uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-left">Insumo</th>
                                    <th class="px-6 py-4 text-left">Quantidade</th>
                                    <th class="px-6 py-4 text-right">Custo</th>
                                    <th class="px-6 py-4 text-center no-print">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="table-usage" class="divide-y divide-[var(--border-subtle)]">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts & History -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-panel p-6">
                                <h4 class="font-black text-xs uppercase mb-4 text-[var(--text-secondary)]">Evolução do Lucro</h4>
                                <div class="h-64"><canvas id="chart-main"></canvas></div>
                            </div>
                            <div class="glass-panel p-6">
                                <h4 class="font-black text-xs uppercase mb-4 text-[var(--text-secondary)]">Proporção (30 dias)</h4>
                                <div class="h-64"><canvas id="chart-pizza"></canvas></div>
                            </div>
                        </div>

                        <!-- History -->
                        <div class="glass-panel p-6 no-print">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-black text-xs uppercase text-electric-500">Histórico de Fechamentos</h4>
                                <button onclick="App.clearHistory()" class="text-[10px] font-black uppercase bg-[var(--bg-tertiary)] hover:bg-red-50 hover:text-red-500 px-3 py-1.5 rounded-lg transition-all">
                                    Limpar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="text-[10px] uppercase text-[var(--text-secondary)] border-b border-[var(--border-subtle)]">
                                        <tr>
                                            <th class="text-left py-3">Data</th>
                                            <th class="text-right py-3">Vendas</th>
                                            <th class="text-right py-3">Custos</th>
                                            <th class="text-right py-3">Lucro</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-history" class="text-sm font-bold divide-y divide-[var(--border-subtle)]">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Side Panel -->
                    <div class="space-y-6 no-print">
                        <div class="glass-panel p-8 bg-gradient-to-br from-navy-900 to-navy-800 text-white">
                            <h4 class="font-black text-[10px] mb-6 text-[var(--text-secondary)] uppercase">Venda Manual (Dinheiro)</h4>
                            <div class="relative">
                                <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl font-black text-navy-400">R$</span>
                                <input type="number" id="manual-sale" class="w-full bg-transparent border-b-2 border-navy-700 text-4xl font-black text-white outline-none pl-10 pb-2 focus:border-electric-500 tabular-nums" placeholder="0,00">
                            </div>
                            <button onclick="Sales.addManualSale()" class="w-full bg-electric-600 hover:bg-electric-500 py-4 mt-6 rounded-xl font-black uppercase text-xs tracking-widest transition-all">
                                Somar ao Caixa
                            </button>
                        </div>

                        <div class="glass-panel p-6">
                            <h4 class="font-black text-[10px] text-[var(--text-secondary)] mb-4 uppercase">Meta Mensal (Break-Even)</h4>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-[var(--text-secondary)]">R$</span>
                                    <input type="number" id="input-meta" class="w-full bg-[var(--bg-tertiary)] pl-8 p-4 rounded-xl text-sm font-bold border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Ex: 5000">
                                </div>
                                <button onclick="App.saveMeta()" class="bg-navy-900 text-white px-6 rounded-xl font-black text-[10px] uppercase hover:bg-navy-800 transition-colors">
                                    Salvar
                                </button>
                            </div>
                            <p class="text-[10px] text-[var(--text-secondary)] mt-2">Define o ponto de equilíbrio mensal</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INVENTORY SECTION -->
            <div id="section-inventory" class="hidden space-y-8 animate-fade-in">
                <div class="glass-panel p-8 no-print">
                    <h4 class="font-black mb-8 uppercase text-xs text-electric-500 tracking-widest">Cadastro de Estoque</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <input type="text" id="inv-name" class="w-full p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Nome do Insumo">
                        <div class="flex gap-2">
                            <input type="number" id="inv-qty" class="p-4 bg-[var(--bg-tertiary)] rounded-xl w-full font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Quantidade">
                            <select id="inv-unit" class="p-4 bg-[var(--bg-tertiary)] rounded-xl text-[10px] font-black uppercase border border-[var(--border-subtle)] outline-none">
                                <option value="kg">KG</option>
                                <option value="L">L</option>
                                <option value="un">UN</option>
                            </select>
                        </div>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-xs font-bold text-[var(--text-secondary)]">R$</span>
                            <input type="number" id="inv-price" class="w-full p-4 pl-8 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Preço Total">
                        </div>
                        <button onclick="Inventory.add()" class="w-full h-[58px] bg-electric-600 text-white font-black rounded-xl text-[10px] uppercase tracking-widest shadow-lg hover:bg-electric-500 transition-all">
                            Cadastrar
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="grid-inventory">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- RECIPES SECTION -->
            <div id="section-recipes" class="hidden space-y-8 animate-fade-in">
                <div class="glass-panel p-8 no-print">
                    <h4 class="font-black mb-8 uppercase text-xs text-electric-500 tracking-widest">Montagem de Receitas</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <input type="text" id="rec-name" class="p-4 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Nome do Produto Final">
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-xs font-bold text-[var(--text-secondary)]">R$</span>
                            <input type="number" id="rec-price" class="w-full p-4 pl-8 bg-[var(--bg-tertiary)] rounded-xl font-bold text-sm border border-[var(--border-subtle)] outline-none focus:border-electric-500" placeholder="Preço de Venda">
                        </div>
                    </div>
                    <div class="p-6 bg-electric-50 rounded-2xl mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="select-ing" class="p-4 bg-white rounded-xl text-sm font-bold border border-electric-200 outline-none focus:border-electric-500">
                                <option value="">Selecionar Insumo...</option>
                            </select>
                            <div class="flex gap-2">
                                <input type="number" id="ing-qty" class="p-4 bg-white rounded-xl w-full text-sm font-bold border border-electric-200 outline-none focus:border-electric-500" placeholder="Qtd">
                                <select id="ing-unit" class="p-4 bg-white rounded-xl text-[10px] font-black uppercase border border-electric-200 outline-none">
                                    <option value="g">g</option>
                                    <option value="ml">ml</option>
                                    <option value="un">un</option>
                                </select>
                            </div>
                            <button onclick="Recipes.addIng()" class="bg-electric-600 text-white rounded-xl font-black text-[10px] uppercase hover:bg-electric-500 transition-all">
                                Vincular
                            </button>
                        </div>
                        <div id="list-temp-ing" class="mt-4 flex flex-wrap gap-2"></div>
                    </div>
                    <button onclick="Recipes.save()" class="w-full py-5 bg-navy-900 text-white rounded-xl font-black uppercase text-xs tracking-widest shadow-xl hover:bg-navy-800 transition-all">
                        Salvar Produto
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="grid-recipes">
                    <!-- Populated by JS -->
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <script>
        // ==========================================
        // STORE - ESTADO CENTRALIZADO
        // ==========================================
        
        const Store = {
            data: {
                license: '',
                storeDoc: '',
                firstAccessDate: null,
                inventory: {},
                recipes: {},
                dailyUsage: [],
                dailySales: 0,
                fixedCost: 0,
                currentFixedLeft: 0,
                historyLog: []
            },

            init() {
                const saved = localStorage.getItem('GP_V73_FIX');
                if (saved) {
                    this.data = JSON.parse(saved);
                }
            },

            save() {
                localStorage.setItem('GP_V73_FIX', JSON.stringify(this.data));
            },

            clear() {
                localStorage.removeItem('GP_V73_FIX');
                location.reload();
            },

            getDaysRemaining() {
                if (!this.data.firstAccessDate) return 365;
                
                const firstAccess = new Date(this.data.firstAccessDate);
                const now = new Date();
                const diffTime = now - firstAccess;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const remaining = 365 - diffDays;
                
                return Math.max(0, remaining);
            },

            isExpired() {
                return this.getDaysRemaining() <= 0;
            },

            getInventory(name) { 
                return this.data.inventory[name]; 
            },
            
            setInventory(name, data) {
                this.data.inventory[name] = data;
                this.save();
            },

            deleteInventory(name) {
                delete this.data.inventory[name];
                this.save();
            },

            getRecipe(name) {
                return this.data.recipes[name];
            },

            setRecipe(name, data) {
                this.data.recipes[name] = data;
                this.save();
            },

            deleteRecipe(name) {
                delete this.data.recipes[name];
                this.save();
            },

            addUsage(usage) {
                this.data.dailyUsage.push({
                    ...usage,
                    id: Date.now(),
                    time: new Date().toLocaleTimeString('pt-BR')
                });
                this.save();
            },

            removeUsage(id) {
                this.data.dailyUsage = this.data.dailyUsage.filter(u => u.id !== id);
                this.save();
            },

            addSale(value) {
                this.data.dailySales += value;
                this.save();
            },

            closeDay() {
                const totalCost = this.data.dailyUsage.reduce((a, b) => a + (b.cost || 0), 0);
                const profit = this.data.dailySales - totalCost;
                
                this.data.historyLog.unshift({
                    date: new Date().toLocaleDateString('pt-BR'),
                    sales: this.data.dailySales,
                    costs: totalCost,
                    profit: profit,
                    timestamp: Date.now()
                });

                this.data.currentFixedLeft = (this.data.currentFixedLeft || this.data.fixedCost) - profit;
                this.data.dailySales = 0;
                this.data.dailyUsage = [];
                this.save();
            },

            clearHistory() {
                this.data.historyLog = [];
                this.save();
            },

            setMeta(value) {
                this.data.fixedCost = value;
                this.data.currentFixedLeft = value;
                this.save();
            },

            getMonthlyStats() {
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const recent = this.data.historyLog.filter(h => h.timestamp > thirtyDaysAgo);
                return recent.reduce((acc, h) => ({
                    sales: acc.sales + h.sales,
                    costs: acc.costs + h.costs,
                    profit: acc.profit + h.profit
                }), { sales: 0, costs: 0, profit: 0 });
            },

            formatMoney(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value || 0);
            }
        };

        // ==========================================
        // UI CONTROLLER
        // ==========================================

        const UI = {
            showModal(id) {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                el.classList.add('flex');
            },

            hideModal(id) {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.classList.remove('flex');
            },

            showToast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                const colors = {
                    success: 'bg-emerald-500',
                    error: 'bg-red-500',
                    warning: 'bg-amber-500',
                    info: 'bg-blue-500'
                };
                
                toast.className = `${colors[type]} text-white px-6 py-4 rounded-xl text-xs font-black uppercase shadow-2xl flex items-center gap-3 animate-slide-up pointer-events-auto`;
                toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i><span>${msg}</span>`;
                
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },

            setLoading(btnId, loading) {
                const btn = document.getElementById(btnId);
                const spinner = btn.querySelector('.fa-spin');
                const text = btn.querySelector('span');
                
                if (loading) {
                    btn.disabled = true;
                    if (spinner) spinner.classList.remove('hidden');
                    if (text) text.textContent = 'Processando...';
                } else {
                    btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (text) text.textContent = 'Confirmar e Baixar';
                }
            },

            updateDaysBadge() {
                const days = Store.getDaysRemaining();
                const badge = document.getElementById('days-left');
                
                badge.textContent = `${days} DIAS`;
                
                badge.classList.remove('warning', 'danger', 'bg-emerald-100', 'text-emerald-700');
                
                if (days <= 7) {
                    badge.classList.add('danger');
                } else if (days <= 30) {
                    badge.classList.add('warning');
                } else {
                    badge.classList.add('bg-emerald-100', 'text-emerald-700');
                }
            },

            showSaleStatus(msg, type = 'info') {
                const statusEl = document.getElementById('sale-status');
                statusEl.textContent = msg;
                statusEl.className = `mt-4 text-xs font-bold text-center ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-emerald-400' : 'text-blue-400'}`;
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
            }
        };

        // ==========================================
        // AUTH
        // ==========================================

        const Auth = {
            login() {
                const doc = document.getElementById('auth-doc').value.replace(/\D/g, '');
                const key = document.getElementById('license-key').value.trim();
                
                if (doc.length < 11 || key.length < 3) {
                    UI.showToast('Preencha todos os campos', 'error');
                    return;
                }

                if (Store.data.firstAccessDate && Store.isExpired()) {
                    UI.showToast('Licença expirada. Contate o suporte.', 'error');
                    return;
                }

                UI.setLoading('btn-login', true);
                
                setTimeout(() => {
                    Store.data.license = key;
                    Store.data.storeDoc = doc;
                    
                    if (!Store.data.firstAccessDate) {
                        Store.data.firstAccessDate = new Date().toISOString();
                    }
                    
                    Store.save();
                    
                    UI.setLoading('btn-login', false);
                    this.unlock();
                }, 1000);
            },

            register() {
                const doc = document.getElementById('reg-doc').value.replace(/\D/g, '');
                const key = document.getElementById('reg-key').value.trim();
                
                if (doc.length < 11 || key.length < 3) {
                    UI.showToast('Preencha todos os campos', 'error');
                    return;
                }

                UI.showToast('Cadastro realizado! Faça login.');
                UI.hideModal('register-modal');
            },

            unlock() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                
                document.getElementById('user-id').textContent = `ID: ${Store.data.storeDoc.slice(-4)}`;
                
                UI.updateDaysBadge();
                
                App.init();
            },

            logout() {
                if (confirm('Deseja sair?')) location.reload();
            }
        };

        // ==========================================
        // APP CONTROLLER
        // ==========================================

        const App = {
            currentTab: 'dash',
            charts: {},

            init() {
                this.setupTabs();
                this.setupInputs();
                Render.all();
                Charts.init();
                
                setInterval(() => UI.updateDaysBadge(), 60000);
            },

            setupTabs() {
                this.switchTab('dash');
            },

            switchTab(tab) {
                this.currentTab = tab;
                
                document.querySelectorAll('main > div[id^="section-"]').forEach(el => {
                    el.classList.add('hidden');
                });
                
                document.getElementById(`section-${tab}`).classList.remove('hidden');
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-[var(--text-secondary)]');
                });
                
                const activeBtn = document.getElementById(`tab-${tab}`);
                activeBtn.classList.add('tab-active');
                activeBtn.classList.remove('text-[var(--text-secondary)]');

                if (tab === 'dash') {
                    setTimeout(() => Charts.update(), 100);
                }
            },

            setupInputs() {
                document.getElementById('auth-doc')?.addEventListener('input', (e) => {
                    let v = e.target.value.replace(/\D/g, '');
                    if (v.length <= 11) {
                        v = v.replace(/(\d{3})(\d)/, '$1.$2');
                        v = v.replace(/(\d{3})(\d)/, '$1.$2');
                        v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    } else {
                        v = v.replace(/^(\d{2})(\d)/, '$1.$2');
                        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                        v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
                        v = v.replace(/(\d{4})(\d)/, '$1-$2');
                    }
                    e.target.value = v;
                });
            },

            saveMeta() {
                const value = parseFloat(document.getElementById('input-meta').value);
                if (isNaN(value) || value <= 0) {
                    UI.showToast('Digite um valor válido', 'error');
                    return;
                }
                Store.setMeta(value);
                Render.dashboard();
                UI.showToast('Meta salva!');
            },

            closeDay() {
                if (!confirm('Confirma fechamento do dia?')) return;
                
                Store.closeDay();
                Render.all();
                UI.showToast('Dia fechado com sucesso!');
            },

            clearHistory() {
                if (!confirm('Limpar todo histórico?')) return;
                Store.clearHistory();
                Render.history();
                UI.showToast('Histórico limpo');
            }
        };

        // ==========================================
        // RENDER ENGINE
        // ==========================================

        const Render = {
            all() {
                this.dashboard();
                this.inventory();
                this.recipes();
                this.history();
                this.selects();
            },

            dashboard() {
                const totalCosts = Store.data.dailyUsage.reduce((sum, u) => sum + (u.cost || 0), 0);
                const profit = Store.data.dailySales - totalCosts;
                const monthly = Store.getMonthlyStats();

                document.getElementById('metric-sales').textContent = Store.formatMoney(Store.data.dailySales);
                document.getElementById('metric-costs').textContent = Store.formatMoney(totalCosts);
                document.getElementById('metric-profit').textContent = Store.formatMoney(profit);
                document.getElementById('metric-profit').className = `text-3xl font-black tabular-nums ${profit >= 0 ? 'text-emerald-600' : 'text-red-500'}`;

                const beCard = document.getElementById('card-be');
                const beLabel = document.getElementById('label-be');
                const beValue = document.getElementById('metric-be');
                const beBadge = document.getElementById('badge-be');
                const beProgress = document.getElementById('progress-be');

                if (!Store.data.fixedCost || Store.data.fixedCost === 0) {
                    beLabel.textContent = 'Meta não definida';
                    beValue.textContent = 'R$ 0,00';
                    beBadge.textContent = 'Configure acima';
                    beBadge.className = 'inline-block mt-2 text-[10px] font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded-full';
                    beCard.className = 'glass-panel p-6 border-b-4 border-gray-400';
                    beProgress.style.width = '0%';
                    beProgress.className = 'bg-gray-400 h-full transition-all duration-500';
                    return;
                }

                const target = Store.data.fixedCost;
                const current = Store.data.currentFixedLeft !== undefined ? Store.data.currentFixedLeft : target;
                const achieved = target - current;
                const percent = Math.min(100, Math.max(0, (achieved / target) * 100));

                if (current <= 0) {
                    beLabel.textContent = 'Lucro Líquido Real';
                    beValue.textContent = Store.formatMoney(Math.abs(current));
                    beValue.className = 'text-2xl font-black tabular-nums text-emerald-600';
                    beBadge.textContent = 'META ALCANÇADA 🚀';
                    beBadge.className = 'inline-block mt-2 text-[10px] font-bold bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full';
                    beCard.className = 'glass-panel p-6 border-b-4 border-emerald-500';
                    beProgress.style.width = '100%';
                    beProgress.className = 'bg-emerald-500 h-full transition-all duration-500';
                } else {
                    beLabel.textContent = 'Pendente Break-Even';
                    beValue.textContent = Store.formatMoney(current);
                    beValue.className = 'text-2xl font-black tabular-nums text-amber-600';
                    beBadge.textContent = `${percent.toFixed(0)}% atingido`;
                    beBadge.className = 'inline-block mt-2 text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded-full';
                    beCard.className = 'glass-panel p-6 border-b-4 border-amber-500';
                    beProgress.style.width = `${percent}%`;
                    beProgress.className = 'bg-amber-500 h-full transition-all duration-500';
                }

                document.getElementById('pdf-sales').textContent = Store.formatMoney(monthly.sales);
                document.getElementById('pdf-costs').textContent = Store.formatMoney(monthly.costs);
                document.getElementById('pdf-profit').textContent = Store.formatMoney(monthly.profit);

                const tbody = document.getElementById('table-usage');
                if (Store.data.dailyUsage.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-[var(--text-secondary)] text-sm">Nenhuma saída registrada hoje</td></tr>';
                } else {
                    tbody.innerHTML = Store.data.dailyUsage.map(u => `
                        <tr class="hover:bg-[var(--bg-tertiary)] transition-colors">
                            <td class="px-6 py-4 font-bold text-xs">${u.name}</td>
                            <td class="px-6 py-4 text-xs font-mono">${u.qty}${u.unit}</td>
                            <td class="px-6 py-4 text-right text-red-500 font-bold tabular-nums">${Store.formatMoney(u.cost)}</td>
                            <td class="px-6 py-4 text-center no-print">
                                <button onclick="Sales.deleteUsage(${u.id})" class="text-[var(--text-secondary)] hover:text-red-500 transition-colors p-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            },

            inventory() {
                const grid = document.getElementById('grid-inventory');
                const items = Object.entries(Store.data.inventory);
                
                if (items.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full glass-panel p-12 text-center text-[var(--text-secondary)]">
                            <i class="fas fa-box-open text-4xl mb-4 opacity-50"></i>
                            <p class="text-sm font-bold uppercase">Nenhum insumo cadastrado</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = items.map(([name, data]) => {
                    const isCritical = data.stock < 500;
                    const displayQty = data.stock >= 1000 ? 
                        `${(data.stock/1000).toFixed(2)}${data.unit === 'g' ? 'kg' : 'L'}` : 
                        `${Math.round(data.stock)}${data.unit}`;
                    
                    return `
                        <div class="glass-panel p-6 ${isCritical ? 'critical-stock' : 'border-t-4 border-electric-500'} relative group">
                            <div class="absolute top-4 right-4 flex gap-2 no-print opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="Inventory.openEdit('${name}')" class="text-electric-500 hover:text-electric-600 bg-electric-50 hover:bg-electric-100 p-2 rounded-lg transition-all" title="Renovar Estoque">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button onclick="Inventory.delete('${name}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-all" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <h4 class="font-black text-[10px] uppercase text-[var(--text-secondary)] mb-2 tracking-widest">${name}</h4>
                            <p class="text-3xl font-black tabular-nums">
                                ${displayQty}
                            </p>
                            <p class="text-[10px] font-bold text-emerald-600 mt-2">
                                ${Store.formatMoney(data.fullUnitPrice)}/${data.originalUnit}
                            </p>
                            ${isCritical ? '<span class="inline-block mt-2 text-[9px] font-black text-red-600 bg-red-100 px-2 py-1 rounded-full animate-pulse">ESTOQUE CRÍTICO</span>' : ''}
                            
                            <div class="mt-3 pt-3 border-t border-[var(--border-subtle)] text-[10px] text-[var(--text-secondary)] no-print">
                                <i class="fas fa-info-circle mr-1"></i>
                                Clique no lápis para renovar
                            </div>
                        </div>
                    `;
                }).join('');
            },

            recipes() {
                const grid = document.getElementById('grid-recipes');
                const recipes = Object.entries(Store.data.recipes);
                
                if (recipes.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full glass-panel p-12 text-center text-[var(--text-secondary)]">
                            <i class="fas fa-utensils text-4xl mb-4 opacity-50"></i>
                            <p class="text-sm font-bold uppercase">Nenhuma receita cadastrada</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = recipes.map(([name, rec]) => `
                    <div class="glass-panel p-6 border-t-4 border-navy-900">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="font-black text-xs uppercase">${name}</h4>
                            <button onclick="Recipes.loadForEdit('${name}')" class="text-electric-500 hover:text-electric-600">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <p class="text-2xl font-black text-emerald-600 tabular-nums">${Store.formatMoney(rec.price)}</p>
                        <p class="text-[10px] text-[var(--text-secondary)] mt-2">${rec.ingredients.length} insumos</p>
                    </div>
                `).join('');
            },

            history() {
                const tbody = document.getElementById('table-history');
                
                if (Store.data.historyLog.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-[var(--text-secondary)] text-sm">Nenhum fechamento registrado</td></tr>';
                    return;
                }

                tbody.innerHTML = Store.data.historyLog.map(h => `
                    <tr class="hover:bg-[var(--bg-tertiary)] transition-colors">
                        <td class="py-3 text-[var(--text-secondary)] text-xs">${h.date}</td>
                        <td class="py-3 text-right font-bold tabular-nums">${Store.formatMoney(h.sales)}</td>
                        <td class="py-3 text-right text-red-400 font-bold tabular-nums">${Store.formatMoney(h.costs)}</td>
                        <td class="py-3 text-right ${h.profit >= 0 ? 'text-emerald-600' : 'text-red-500'} font-black tabular-nums">
                            ${Store.formatMoney(h.profit)}
                        </td>
                    </tr>
                `).join('');
            },

            selects() {
                const options = Object.keys(Store.data.inventory)
                    .sort()
                    .map(n => `<option value="${n}">${n}</option>`)
                    .join('');

                ['select-insumo', 'select-ing'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        const current = el.value;
                        el.innerHTML = `<option value="">Selecionar...</option>${options}`;
                        el.value = current;
                    }
                });

                const prodSelect = document.getElementById('select-product');
                if (prodSelect) {
                    const current = prodSelect.value;
                    const prodOptions = Object.keys(Store.data.recipes)
                        .sort()
                        .map(n => `<option value="${n}">${n}</option>`)
                        .join('');
                    prodSelect.innerHTML = `<option value="">Selecionar Produto...</option>${prodOptions}`;
                    prodSelect.value = current;
                }
            }
        };

        // ==========================================
        // CHARTS
        // ==========================================

        const Charts = {
            init() {
                this.initMain();
                this.initPizza();
            },

            initMain() {
                const ctx = document.getElementById('chart-main')?.getContext('2d');
                if (!ctx) return;

                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                App.charts.main = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Lucro',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => Store.formatMoney(ctx.parsed.y)
                                }
                            }
                        },
                        scales: {
                            x: { grid: { display: false } },
                            y: {
                                border: { display: false },
                                grid: { color: '#f1f5f9' },
                                ticks: {
                                    callback: (v) => `R$ ${v/1000}k`
                                }
                            }
                        }
                    }
                });
            },

            initPizza() {
                const ctx = document.getElementById('chart-pizza')?.getContext('2d');
                if (!ctx) return;

                App.charts.pizza = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Vendas', 'Custos'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['#3b82f6', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            },

            update() {
                if (!App.charts.main || !App.charts.pizza) return;

                const recent = [...Store.data.historyLog].slice(0, 7).reverse();
                App.charts.main.data.labels = recent.map(h => h.date);
                App.charts.main.data.datasets[0].data = recent.map(h => h.profit);
                App.charts.main.update();

                const monthly = Store.getMonthlyStats();
                App.charts.pizza.data.datasets[0].data = [monthly.sales, monthly.costs];
                App.charts.pizza.update();
            }
        };

        // ==========================================
        // INVENTORY MODULE
        // ==========================================

        const Inventory = {
            editingItem: null,

            add() {
                const name = document.getElementById('inv-name').value.trim().toUpperCase();
                const qty = parseFloat(document.getElementById('inv-qty').value);
                const unit = document.getElementById('inv-unit').value;
                const price = parseFloat(document.getElementById('inv-price').value);

                if (!name || isNaN(qty) || isNaN(price) || qty <= 0 || price <= 0) {
                    UI.showToast('Preencha todos os campos corretamente', 'error');
                    return;
                }

                let baseQty = (unit === 'kg' || unit === 'L') ? qty * 1000 : qty;
                let baseUnit = unit === 'kg' ? 'g' : unit === 'L' ? 'ml' : 'un';

                const existing = Store.getInventory(name);
                if (existing) {
                    const totalQty = existing.stock + baseQty;
                    const totalPrice = (existing.stock * existing.pricePerBase) + price;
                    
                    Store.setInventory(name, {
                        stock: totalQty,
                        pricePerBase: totalPrice / totalQty,
                        fullUnitPrice: totalPrice / (totalQty / (unit === 'kg' || unit === 'L' ? 1000 : 1)),
                        unit: baseUnit,
                        originalUnit: unit
                    });
                } else {
                    Store.setInventory(name, {
                        stock: baseQty,
                        pricePerBase: price / baseQty,
                        fullUnitPrice: price / qty,
                        unit: baseUnit,
                        originalUnit: unit
                    });
                }

                document.getElementById('inv-name').value = '';
                document.getElementById('inv-qty').value = '';
                document.getElementById('inv-price').value = '';

                Render.inventory();
                Render.selects();
                UI.showToast('Insumo cadastrado!');
            },

            openEdit(name) {
                const item = Store.getInventory(name);
                if (!item) return;

                this.editingItem = name;
                
                document.getElementById('edit-item-name').textContent = name;
                document.getElementById('edit-current-stock').textContent = 
                    `${Math.round(item.stock)} ${item.unit}`;
                
                const unitSelect = document.getElementById('edit-unit');
                unitSelect.value = item.originalUnit || 'kg';
                
                document.getElementById('edit-add-qty').value = '';
                document.getElementById('edit-add-price').value = '';

                UI.showModal('edit-inventory-modal');
            },

            saveEdit() {
                if (!this.editingItem) return;

                const qty = parseFloat(document.getElementById('edit-add-qty').value);
                const unit = document.getElementById('edit-unit').value;
                const price = parseFloat(document.getElementById('edit-add-price').value);

                if (isNaN(qty) || isNaN(price) || qty <= 0 || price <= 0) {
                    UI.showToast('Preencha quantidade e preço', 'error');
                    return;
                }

                const item = Store.getInventory(this.editingItem);
                
                let baseQty = (unit === 'kg' || unit === 'L') ? qty * 1000 : qty;
                
                const currentTotalValue = item.stock * item.pricePerBase;
                const newValue = price;
                const newTotalQty = item.stock + baseQty;
                
                const newPricePerBase = (currentTotalValue + newValue) / newTotalQty;
                
                Store.setInventory(this.editingItem, {
                    stock: newTotalQty,
                    pricePerBase: newPricePerBase,
                    fullUnitPrice: newPricePerBase * (unit === 'kg' || unit === 'L' ? 1000 : 1),
                    unit: item.unit,
                    originalUnit: item.originalUnit
                });

                UI.hideModal('edit-inventory-modal');
                Render.inventory();
                UI.showToast(`Estoque de ${this.editingItem} renovado!`);
                
                this.editingItem = null;
            },

            delete(name) {
                if (!confirm(`Excluir ${name}?`)) return;
                Store.deleteInventory(name);
                Render.inventory();
                Render.selects();
                UI.showToast('Insumo removido');
            }
        };

        // ==========================================
        // RECIPES MODULE
        // ==========================================

        const Recipes = {
            tempIngredients: [],

            addIng() {
                const name = document.getElementById('select-ing').value;
                const qty = parseFloat(document.getElementById('ing-qty').value);
                const unit = document.getElementById('ing-unit').value;

                if (!name || isNaN(qty) || qty <= 0) {
                    UI.showToast('Selecione insumo e quantidade', 'error');
                    return;
                }

                this.tempIngredients.push({ id: Date.now(), name, qty, unit });
                this.renderTemp();
                
                document.getElementById('ing-qty').value = '';
            },

            removeIng(id) {
                this.tempIngredients = this.tempIngredients.filter(i => i.id !== id);
                this.renderTemp();
            },

            renderTemp() {
                const container = document.getElementById('list-temp-ing');
                container.innerHTML = this.tempIngredients.map(i => `
                    <span class="inline-flex items-center gap-2 bg-electric-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold">
                        ${i.name} ${i.qty}${i.unit}
                        <button onclick="Recipes.removeIng(${i.id})" class="hover:bg-white/20 rounded p-0.5">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `).join('');
            },

            save() {
                const name = document.getElementById('rec-name').value.trim().toUpperCase();
                const price = parseFloat(document.getElementById('rec-price').value);

                if (!name || isNaN(price) || price <= 0) {
                    UI.showToast('Preencha nome e preço', 'error');
                    return;
                }

                if (this.tempIngredients.length === 0) {
                    UI.showToast('Adicione pelo menos um insumo', 'error');
                    return;
                }

                Store.setRecipe(name, {
                    price,
                    ingredients: [...this.tempIngredients]
                });

                this.tempIngredients = [];
                document.getElementById('rec-name').value = '';
                document.getElementById('rec-price').value = '';
                this.renderTemp();

                Render.recipes();
                Render.selects();
                UI.showToast('Receita salva!');
            },

            loadForEdit(name) {
                const rec = Store.getRecipe(name);
                if (!rec) return;

                document.getElementById('rec-name').value = name;
                document.getElementById('rec-price').value = rec.price;
                this.tempIngredients = [...rec.ingredients];
                this.renderTemp();
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                UI.showToast(`Editando: ${name}`, 'warning');
            }
        };

        // ==========================================
        // SALES MODULE - CORRIGIDO E REFATORADO
        // ==========================================

        const Sales = {
            // CORREÇÃO PRINCIPAL: Venda automática por ficha técnica
            sellProduct() {
                console.log('Iniciando venda automática...');
                
                // Obtém elementos diretamente
                const productSelect = document.getElementById('select-product');
                const qtyInput = document.getElementById('sale-qty');
                
                if (!productSelect || !qtyInput) {
                    console.error('Elementos não encontrados!');
                    UI.showToast('Erro interno. Recarregue a página.', 'error');
                    return;
                }

                const productName = productSelect.value;
                const qty = parseFloat(qtyInput.value);

                console.log('Produto:', productName, 'Qtd:', qty);

                // Validações
                if (!productName || productName === '') {
                    UI.showToast('Selecione um produto', 'error');
                    productSelect.focus();
                    return;
                }

                if (isNaN(qty) || qty <= 0) {
                    UI.showToast('Digite uma quantidade válida', 'error');
                    qtyInput.focus();
                    return;
                }

                const recipe = Store.getRecipe(productName);
                if (!recipe) {
                    UI.showToast('Receita não encontrada', 'error');
                    return;
                }

                console.log('Receita encontrada:', recipe);

                // Verifica se há ingredientes
                if (!recipe.ingredients || recipe.ingredients.length === 0) {
                    UI.showToast('Receita sem insumos cadastrados', 'error');
                    return;
                }

                // Verifica estoque de todos os insumos antes de consumir
                let hasError = false;
                const usagePlan = []; // Plano de consumo

                for (const ing of recipe.ingredients) {
                    const item = Store.getInventory(ing.name);
                    
                    if (!item) {
                        UI.showToast(`Insumo "${ing.name}" não existe no estoque`, 'error');
                        hasError = true;
                        break;
                    }

                    // Calcula quantidade necessária na unidade base do estoque
                    let neededQty;
                    if (ing.unit === 'g' || ing.unit === 'ml') {
                        // Se a receita usa g/ml, e estoque é g/ml, multiplica direto
                        neededQty = ing.qty * qty;
                    } else {
                        // unidades
                        neededQty = ing.qty * qty;
                    }

                    console.log(`Insumo ${ing.name}: precisa ${neededQty}${item.unit}, tem ${item.stock}${item.unit}`);

                    if (neededQty > item.stock) {
                        UI.showToast(`Estoque insuficiente: ${ing.name} (precisa: ${neededQty}${item.unit}, tem: ${Math.round(item.stock)}${item.unit})`, 'error');
                        hasError = true;
                        break;
                    }

                    usagePlan.push({
                        name: ing.name,
                        neededQty: neededQty,
                        item: item,
                        unitCost: item.pricePerBase
                    });
                }

                if (hasError) return;

                console.log('Plano de consumo:', usagePlan);

                // Executa o consumo
                let totalCost = 0;
                
                for (const plan of usagePlan) {
                    // Atualiza estoque
                    plan.item.stock -= plan.neededQty;
                    const cost = plan.neededQty * plan.unitCost;
                    totalCost += cost;

                    // Salva alteração no estoque
                    Store.setInventory(plan.name, plan.item);

                    // Registra uso
                    Store.addUsage({
                        name: plan.name,
                        qty: plan.neededQty,
                        unit: plan.item.unit,
                        cost: cost,
                        product: productName,
                        type: 'auto'
                    });

                    console.log(`Consumido: ${plan.name} - ${plan.neededQty}${plan.item.unit} = ${Store.formatMoney(cost)}`);
                }

                // Calcula e adiciona venda
                const revenue = recipe.price * qty;
                Store.addSale(revenue);

                console.log('Venda total:', Store.formatMoney(revenue), 'Custo:', Store.formatMoney(totalCost));

                // Limpa inputs
                qtyInput.value = '';
                productSelect.value = '';

                // Atualiza interface
                Render.dashboard();
                Render.inventory();
                
                const profit = revenue - totalCost;
                UI.showToast(`✅ Venda: ${Store.formatMoney(revenue)} | Lucro: ${Store.formatMoney(profit)}`);
            },

            addManualUsage() {
                const name = document.getElementById('select-insumo').value;
                const qty = parseFloat(document.getElementById('usage-qty-input').value);
                const unit = document.getElementById('usage-unit-input').value;

                if (!name || isNaN(qty) || qty <= 0) {
                    UI.showToast('Selecione insumo e quantidade', 'error');
                    return;
                }

                const item = Store.getInventory(name);
                if (!item) {
                    UI.showToast('Insumo não encontrado', 'error');
                    return;
                }

                let baseQty = (unit === 'kg' || unit === 'L') ? qty * 1000 : qty;
                
                if (baseQty > item.stock) {
                    UI.showToast(`Estoque insuficiente. Disponível: ${item.stock}${item.unit}`, 'error');
                    return;
                }

                item.stock -= baseQty;
                Store.setInventory(name, item);

                const cost = baseQty * item.pricePerBase;
                Store.addUsage({
                    name,
                    qty: baseQty,
                    unit: item.unit,
                    cost,
                    type: 'manual'
                });

                document.getElementById('usage-qty-input').value = '';
                
                Render.dashboard();
                Render.inventory();
                UI.showToast('Uso registrado');
            },

            addManualSale() {
                const value = parseFloat(document.getElementById('manual-sale').value);
                
                if (isNaN(value) || value <= 0) {
                    UI.showToast('Digite um valor válido', 'error');
                    return;
                }

                Store.addSale(value);
                document.getElementById('manual-sale').value = '';
                
                Render.dashboard();
                UI.showToast(`Venda adicionada: ${Store.formatMoney(value)}`);
            },

            deleteUsage(id) {
                const usage = Store.data.dailyUsage.find(u => u.id === id);
                if (!usage) return;

                const item = Store.getInventory(usage.name);
                if (item) {
                    item.stock += usage.qty;
                    Store.setInventory(usage.name, item);
                }

                if (usage.type === 'auto' && usage.product) {
                    const recipe = Store.getRecipe(usage.product);
                    if (recipe) {
                        // Estima unidades vendidas baseado no custo
                        const ingInRecipe = recipe.ingredients.find(i => i.name === usage.name);
                        if (ingInRecipe) {
                            const unitsSold = Math.round(usage.qty / ingInRecipe.qty);
                            Store.data.dailySales -= (recipe.price * unitsSold);
                        }
                    }
                }

                Store.removeUsage(id);
                
                Render.dashboard();
                Render.inventory();
                UI.showToast('Operação cancelada');
            }
        };

        // ==========================================
        // REPORTS
        // ==========================================

        const Reports = {
            generatePDF() {
                document.getElementById('pdf-date').textContent = new Date().toLocaleString('pt-BR');
                document.getElementById('pdf-summary').classList.remove('hidden');
                window.print();
                setTimeout(() => {
                    document.getElementById('pdf-summary').classList.add('hidden');
                }, 100);
            },

            sendWhatsApp() {
                const totalCost = Store.data.dailyUsage.reduce((a, b) => a + (b.cost || 0), 0);
                const profit = Store.data.dailySales - totalCost;
                const status = Store.data.currentFixedLeft <= 0 ? 
                    `✅ Lucro Líquido: ${Store.formatMoney(Math.abs(Store.data.currentFixedLeft))}` :
                    `⏳ Break-Even: ${Store.formatMoney(Store.data.currentFixedLeft)}`;

                const msg = `🚀 *GESTÃO PRO - RELATÓRIO*%0A%0A` +
                           `💰 Vendas: ${Store.formatMoney(Store.data.dailySales)}%0A` +
                           `📉 Custos: ${Store.formatMoney(totalCost)}%0A` +
                           `📊 Lucro: ${Store.formatMoney(profit)}%0A%0A` +
                           `${status}`;

                window.open(`https://wa.me/?text=${msg}`);
            }
        };

        // ==========================================
        // INIT
        // ==========================================

        Store.init();
        
        window.UI = UI;
        window.Auth = Auth;
        window.App = App;
        window.Inventory = Inventory;
        window.Recipes = Recipes;
        window.Sales = Sales;
        window.Reports = Reports;
        
        // Debug: expõe Store para console
        window.Store = Store;
    </script>
</body>
</html>
